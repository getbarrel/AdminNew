<?php

//header("Cache-control: no-cache");
//header("Pragma: no-cache");
//header("P3P:CP=\"NOI DSP COR DEVa TAIa OUR BUS UNI COM NAV STA PRE\"");


Class forbizGather
{
	var $fREQUEST_URI;
	var $fPHP_SELF;
	var $fHTTP_REFERER;
	var $fHTTP_HOST;
	var $fREMOTE_ADDR;
	var $VISITID;
	var $VISITORID;
	var $VisitCookie;
	var $VisitTime;
	var $VisitDate;
	var $fRefererID;
	var $fetcRefererID;
	var $SearchParam;
	var $SearchKeyWordId;
	var $PageID;
	var $DurationTime;
	var $BEFORE_LAST_CON_TIME;
	var $USERID ;
	var $UCODE ;

	var $COOKIE_HOST;
	var $OVER_TURE;
	var $PARAM_ANALISYS;
	var $KID;
	var $debug;

	var $fHOST;
	var $siteID;
	var $data_root;
	var $agent_type = "W";

	public function __construct(){
		global $PHP_SELF,$HTTP_REFERER,$HTTP_HOST,$REMOTE_ADDR, $REQUEST_URI, $HTTP_USER_AGENT;


		if(!(substr_count(strtolower($HTTP_HOST), strtolower("mallstory.com")) > 0)){
			$adb = new forbizDatabase();

			$sql = "insert into ".TBL_LOGSTORY_ETCHOST." (idx,referer, etcuri,etchost) values ('','".strtolower($HTTP_REFERER)."','".strtolower($REQUEST_URI)."','".strtolower($HTTP_HOST)."') ";
			//echo $sql;
			//$adb->query($sql);
		}

	}

	function CheckDuration(){
		global $HTTP_HOST;
		if(empty($_COOKIE["LAST_CON_TIME"])){
			setcookie("LAST_CON_TIME",time(), time()+1800,"/",$HTTP_HOST);
			return 0;
		}else{
			$Before_Duration = $_COOKIE["LAST_CON_TIME"];
			setcookie("LAST_CON_TIME",time(), time()+1800,"/",$HTTP_HOST);
			return time()-$Before_Duration;
		}


	}

	function VisitSetCookie(){
		//setcookie("VID",$URL, time()+180000,"/",$HTTP_HOST);

	}

	function CheckReferer111($this_referer, $this_url=''){

		if($_COOKIE["VID"] == ""){
			$db = new forbizDatabase();


					$sql = "select cid,vreferer_url,vkeyword, vparameter , case when vparameter = '' then 0 else 1 end as paramorder
									from ".TBL_LOGSTORY_REFERER_CATEGORYINFO."
									where vparameter <> '' and depth in (2,3,4,5)
									order by paramorder desc";
					$db->query($sql);

					for($i=0;$i<$db->total;$i++){
						$db->fetch($i);
	

						if ($this_referer == "" || substr_count($this_referer,$this->fHTTP_HOST) > 0 ){
							 

							if($this->SearchString($db->dt['vparameter'],$db->dt['cid'],$this_url)){
								if($db->dt['vparameter'] == "OVRAW"){
									$this->OVER_TURE = true;
								}
								$this->PARAM_ANALISYS = true;
								$this->SearchParam = $db->dt['vparameter'];
								return $db->dt['cid'];
								exit;
							}
						}else{
							if($this->SearchString(str_replace("*.","",$db->dt['vreferer_url']),$db->dt['cid'],$this_referer)){
								if($this->SearchString($db->dt['vparameter'],$db->dt['cid'],$this_url)){
									if($db->dt['vparameter'] == "OVRAW"){
										$this->OVER_TURE = true;
									}
									$this->PARAM_ANALISYS = true;
									$this->SearchParam = $db->dt['vparameter'];
									return $db->dt['cid'];
									exit;
								}
							}
						}

					}


					if ($this_referer == ""){
							return "000005000000000";
					}

					$sql = "select cid,vreferer_url,vkeyword, vparameter , case when vparameter = '' then 0 else 1 end as paramorder
									from ".TBL_LOGSTORY_REFERER_CATEGORYINFO."
									where vreferer_url != '' and depth in (2,3,4,5)
									order by paramorder desc";

					$db->query($sql);

					for($i=0;$i<$db->total;$i++){
						$db->fetch($i);

						if($db->dt['vreferer_url'] != ""){
							if($this->SearchString(str_replace("*.","",$db->dt['vreferer_url']),$db->dt['cid'],$this_referer)){
								$this->SearchParam = $db->dt['vkeyword'];
								return $db->dt['cid'];
								exit;
							}
						}
					}


			if($this->SearchString($this->fHTTP_HOST,"000005000000000",$this_referer)){
				return "000005000000000";
			}else{
				$this->fetcRefererID = $this->InsertEtcReferer($this_referer);
				return "000004000000000";
			}

		}else{
			return $_COOKIE["RFID"];
		}


	}


	function CheckReferer($this_referer, $this_url=''){
		//echo $this_referer;
		if(empty($_COOKIE["VID"]) || $this->debug){
		//echo $this_referer;
			$db = new forbizDatabase();
			$db->debug = $this->debug;

					$sql = "select cid,vreferer_url,vkeyword, vparameter , case when vparameter = '' then 0 else 1 end as paramorder
									from ".TBL_LOGSTORY_REFERER_CATEGORYINFO."
									where  depth in (2,3,4)
									order by paramorder desc"; //vparameter <> '' and
					$db->query($sql);
					//echo $sql."<br>";
					for($i=0;$i<$db->total;$i++){
						$db->fetch($i);
 

						if (trim($db->dt['vparameter']) || $this_referer == "" || substr_count($this_referer,$this->fHTTP_HOST) > 0 ){

						  
							if($this->SearchString($db->dt['vparameter'],$db->dt['cid'],$this_url) || ($db->dt['vparameter'] == $this_referer && $db->dt['vparameter'] != "")){ // �ش� �Ķ���Ͱ� ������
								if($db->dt['vparameter'] == "OVRAW"){	// �Ķ���Ͱ� OVRAW �̸� �����߾� �м�
									$this->OVER_TURE = true;
								}
								$this->PARAM_ANALISYS = true;
								$this->SearchParam = $db->dt['vparameter'];
								//echo "vparameter:'".$db->dt['vparameter']."'<br>";
								//echo "this_referer:".$this_referer."<br>";
								//echo substr_count($this_referer,$this->fHTTP_HOST)."<br>" ;
								return $db->dt['cid'];
								exit;
							}
						}else{

							if($this->SearchString(str_replace("*.","",$db->dt['vreferer_url']),$db->dt['cid'],$this_referer)){
							//echo $db->dt['cid'];
								if($this->SearchString($db->dt['vkeyword'],$db->dt['cid'],$this_referer)){
									if($db->dt['vparameter'] == "OVRAW"){
										$this->OVER_TURE = true;
									}
									$this->PARAM_ANALISYS = false;
									$this->SearchParam = $db->dt['vkeyword'];
									//echo $db->dt['cid'];

									return $db->dt['cid'];
									exit;
								}
							}
						}

					}


					if ($this_referer == ""){
							return "000005000000000";
					}

					$sql = "select cid,vreferer_url,vkeyword, vparameter , case when vparameter = '' then 0 else 1 end as paramorder
									from ".TBL_LOGSTORY_REFERER_CATEGORYINFO."
									where vreferer_url != '' and depth in (2,3,4)
									order by paramorder desc";

					$db->query($sql);

					for($i=0;$i<$db->total;$i++){
						$db->fetch($i);

						if($db->dt['vreferer_url'] != ""){
							if($this->SearchString(str_replace("*.","",$db->dt['vreferer_url']),$db->dt['cid'],$this_referer)){
								$this->SearchParam = $db->dt['vkeyword'];
								return $db->dt['cid'];
								exit;
							}
						}
					}


			if($this->SearchString($this->fHTTP_HOST,"000005000000000",$this_referer)){
				return "000005000000000";
			}else{
				$this->fetcRefererID = $this->InsertEtcReferer($this_referer);
				return "000004000000000";
			}

		}else{
			return $_COOKIE["RFID"];
		}


	}


	function GetPageID($pageurl){

			$db = new forbizDatabase();

			$db->query("select pageid from ".TBL_LOGSTORY_PAGEINFO." where vurl = '".strtolower($pageurl)."'");

			if($db->total > 0){
				$db->fetch(0);
				$this->PageViewInsertByPage($db->dt['pageid']);
				setcookie("PAGEID",$db->dt['pageid'], time()+180000,"/",$_SERVER['HTTP_HOST']);
				return $db->dt['pageid'];


			}else{
				$sql = "insert into ".TBL_LOGSTORY_PAGEINFO." (pageid,vurl,vdate) values ('','".strtolower($pageurl)."','".$this->VisitDate."') ";
				$db->query($sql);
				if($db->dbms_type == "oracle"){
					$pageid = $db->last_insert_id;
				}else{
					$db->query("SELECT pageid FROM ".TBL_LOGSTORY_PAGEINFO." WHERE pageid=LAST_INSERT_ID()");
					$db->fetch(0);
					$pageid = $db->dt['pageid'];
				}
				$this->PageViewInsertByPage($pageid);
				setcookie("PAGEID",$db->dt['pageid'], time()+180000,"/",$HTTP_HOST);
				return $db->dt['pageid'];
			}
	}

	function PageViewInsertByPage($page_id){
		global $user,$mall_data_root;
		$db = new forbizDatabase();

		$db->query("select pageid from ".TBL_LOGSTORY_BYPAGE." where pageid = '$page_id' and vdate ='".$this->VisitDate."'");

		if($db->total > 0){
			$db->query("update ".TBL_LOGSTORY_BYPAGE." set ncnt = ncnt+1, nduration = nduration + ".$this->DurationTime." where pageid = '".$page_id."' and vdate ='".$this->VisitDate."'");
		}else{
			$db->query("insert into ".TBL_LOGSTORY_BYPAGE." (vdate,pageid) values ('".$this->VisitDate."','".$page_id."') ");
		}

		if(class_exists("Memcache")){ 
//			$memcache = new Memcache;
//			//$memcache_obj = memcache_connect("183.111.154.6 ", 22);
//			$memcache->connect(MEMCACHE_IP, MEMCACHE_PORT);
//			$realtime_data = $memcache->get('realtime_data');
//
//			$realtime_data[$_COOKIE["VID"]] = array(
//							'server_addr' => $_SERVER["SERVER_ADDR"],
//							'ipaddr' => $_SERVER["REMOTE_ADDR"],
//							'user_id' => $this->USERID,
//							'user_code' => $this->UCODE,
//							'page_id' => $page_id,
//							'before_visit_date' => date("Y-m-d H:i:s",$this->BEFORE_LAST_CON_TIME),
//							'recent_visit_date' => date("Y-m-d H:i:s"),
//							'VID' => $_COOKIE["VID"],
//							'RFID' => $_COOKIE["RFID"],
//							'APP_TYPE' => $_SESSION['app_type']
//							);
//
//
//			$result = $memcache->add("realtime_data", $realtime_data, false, 100);
//			if(!$result){
//				$result = $memcache->set("realtime_data", $realtime_data, false, 100);
//			}
		}else{

			$shmop = new Shared("realtime_data");
			$shmop->filepath = $_SERVER["DOCUMENT_ROOT"].$mall_data_root."/_shared/";
			//echo $shmop->filepath;
			$shmop->SetFilePath();
			$realtime_data = $shmop->getObjectForKey("realtime_data");
			//$realtime_data[md5($_SERVER["REMOTE_ADDR"])] = array('ipaddr' => $_SERVER["REMOTE_ADDR"], 'user_id' => $this->USERID,  'user_code' => $this->UCODE, 'page_id' => $page_id, 'before_visit_date' => date("Y-m-d H:i:s",$this->BEFORE_LAST_CON_TIME), 'recent_visit_date' => date("Y-m-d H:i:s"));


			$realtime_data[$_COOKIE["VID"]] = array('server_addr' => $_SERVER["SERVER_ADDR"],'ipaddr' => $_SERVER["REMOTE_ADDR"], 'user_id' => $this->USERID,  'user_code' => $this->UCODE, 'page_id' => $page_id, 'before_visit_date' => date("Y-m-d H:i:s",(int)$this->BEFORE_LAST_CON_TIME), 'recent_visit_date' => date("Y-m-d H:i:s"), 'VID' => $_COOKIE["VID"],	'RFID' => $_COOKIE["RFID"], 'APP_TYPE' => $_SESSION['app_type']);

			if(count($realtime_data) > 100){
				foreach ($realtime_data as $key => $row) {
					if((time()- strtotime($row['recent_visit_date'])) > 600){
					unset($realtime_data[$key]);
				  }
				}
			}


			$shmop->setObjectForKey($realtime_data, "realtime_data") ;
		}

	}

	function InsertEtcReferer($vreferer_url){

			$db = new forbizDatabase();



			$db->query("select vetcreferer_id from ".TBL_LOGSTORY_ETCREFERERINFO." where vetcreferer_url = '".strtolower($vreferer_url)."'");



			if($db->total > 0){
				$db->fetch(0);
				return $db->dt['vetcreferer_id'];
			}else{
				$sql = "insert into ".TBL_LOGSTORY_ETCREFERERINFO." (vetcreferer_id,vetcreferer_url,vdate) values ('','".strtolower($vreferer_url)."','".$this->VisitDate."') ";
				$db->query($sql);

				if($db->dbms_type == "oracle"){
					$vetcreferer_id = $db->last_insert_id;
				}else{
					$db->query("SELECT vetcreferer_id FROM ".TBL_LOGSTORY_ETCREFERERINFO." WHERE vetcreferer_id=LAST_INSERT_ID()");
					$db->fetch(0);
					$vetcreferer_id = $db->dt['vetcreferer_id'];
				}

				return $vetcreferer_id;
			}
	}

	function SearchString($str,$ref_id,$referer_url){
		$numarray = explode(",", $str);
		$size = count($numarray);
		parse_str($referer_url, $paraminfos);
		//print_r($paraminfos);
		for($i=0;$i < $size;$i++){
			if(@substr_count(strtolower($referer_url), strtolower($numarray[$i])) > 0){

			//if($paraminfos[strtolower($numarray[$i])]){
				$this->SearchParam = strtolower($numarray[$i]);
				return true;
			}
		}

		return false;
	}

	function InsertKeyWord($vreferer_url, $vrequest_uri){
		//echo $this->SearchParam;

		if($this->SearchParam == ""){
			//echo "����";
			return "";
			exit;
		}
		if($this->PARAM_ANALISYS){
			parse_str(urldecode($vrequest_uri), $myarray);
		}else{
			parse_str(urldecode($vreferer_url), $myarray);
		}

		//print_r($myarray);
		//echo $myarray[$this->SearchParam];

			$db = new forbizDatabase();
			if($this->debug){
				echo "key word encoding type check before : ".$this->SearchParam."<br><br>";
			}
			$db->debug = $this->debug;

			$encoding_type = mb_detect_encoding(urldecode($myarray[$this->SearchParam]));
			if($encoding_type == "UTF-8"){
				if($this->debug){
					echo "encoding type UTF-8 <br><br>";
				}
				//$search_keyword = iconv('CP949','UTF-8',urldecode($myarray[$this->SearchParam]));
				$search_keyword = urldecode($myarray[$this->SearchParam]);

				if($this->debug){
					echo " search_keyword : ".$search_keyword."<br><br>";
				}

				if($search_keyword == ""){
					$search_keyword = urldecode($myarray[$this->SearchParam]);
				}
			}else{
				$search_keyword = iconv('CP949','UTF-8',urldecode($myarray[$this->SearchParam]));
				if($search_keyword == ""){
					$search_keyword = urldecode($myarray[$this->SearchParam]);
				}
			}
			$db->query("select kid from ".TBL_LOGSTORY_KEYWORDINFO." where keyword = '".$search_keyword."' limit 0, 1");

			if($db->total > 0){
				$db->fetch(0);
				return $db->dt['kid'];
			}else{
				//if($this->fRefererID == "000001001000000"){

				$sql = "insert into ".TBL_LOGSTORY_KEYWORDINFO." (kid,keyword,charset,vdate) values ('','".$search_keyword."', '".$encoding_type."',NOW()) ";
				$db->sequences = "LOGSTORY_KEYWORDINFO_SEQ";
				$db->query($sql);

				if($db->dbms_type == "oracle"){
					$kid = $db->last_insert_id;
				}else{
					$db->query("SELECT kid FROM ".TBL_LOGSTORY_KEYWORDINFO." WHERE kid=LAST_INSERT_ID()");
					$db->fetch(0);
					$kid = $db->dt['kid'];
				}
				return $kid;
			}
	}
}

//echo phpinfo();


/*
$fg = new forbizGather();

echo "fRefererID".$fg->fRefererID."<br>";


echo "URL:".$REQUEST_URI."<BR>";
echo "PHP_SELF:".$PHP_SELF."<BR>";
echo "HTTP_REFERER:".$HTTP_REFERER."<BR>";
echo "HTTP_HOST:".$HTTP_HOST."<BR>";
echo "REMOTE_ADDR:".$REMOTE_ADDR."<BR>";
echo "QUERY_STRING:".$QUERY_STRING."<BR>";
echo "TIME:".date("H", time())."<br>";
echo "DATE_STR:".date("Ymd", time())."<br>";
echo "DATE:".date("M d Y H:i:s", time())."<br>";
echo "VID:".md5(uniqid(rand()))."<br>";
*/

?>
