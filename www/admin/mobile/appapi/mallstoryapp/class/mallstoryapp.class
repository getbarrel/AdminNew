<?php

class MallstoryApp
{

	var $ResultDataType = "json";			//xml or json
	var $Debug = 0;
	var $__dispatch_map = array();
	
	public function __construct(){

		$this->__dispatch_map['getCategorys'] = array('in' => array('cid' => 'string' ),'out' => array('results' => 'string'));

	}

	public function getCategorys($parent_cid=""){

		$db = new Database;
		
		if($parent_cid != "" && $parent_cid !="0"){
			$sql = "SELECT * FROM ".TBL_SHOP_CATEGORY_INFO."
					where depth in(0,1,2,3,4,5)  and category_use = '1' and cid = '".$parent_cid."'
					order by vlevel1, vlevel2, vlevel3, vlevel4, vlevel5";

			$db->query($sql);
			$db->fetch();
			$parent_categoryinfo = $db->dt;

			$where = " and cid LIKE '".substr($parent_cid,0,($parent_categoryinfo[depth]+1)*3)."%' and depth = '".($parent_categoryinfo[depth]+1)."' ";
		}else{
			$where = " and depth = '0' ";
		}

		$sql = "SELECT cid,cname FROM ".TBL_SHOP_CATEGORY_INFO."
					where depth in(0,1,2,3,4,5)  and category_use = '1'
					".$where."
					order by vlevel1, vlevel2, vlevel3, vlevel4, vlevel5";

		//return $sql;

		$db->query($sql);
		$categorys = $db->fetchall("object");

		if($this->ResultDataType=="xml"){
			if(count($categorys) > 0){

				$xml = new XmlWriter_();
				$xml->push('categorys', array('total'=>count($categorys)));

				foreach ($categorys as $category) {
					$xml->push('category', array('cid' => $category[cid]));
					$xml->element('cid', $category[cid]);
					$xml->element('cname', strip_tags(htmlspecialchars($category[cname])));
					//$xml->element('eng_cname', strip_tags(htmlspecialchars($category[eng_cname])));
					//$xml->element('depth', $category[depth]);
					//$xml->element('vlevel1', $category[vlevel1]);
					//$xml->element('vlevel2', $category[vlevel2]);
					//$xml->element('vlevel3', $category[vlevel3]);
					//$xml->element('vlevel4', $category[vlevel4]);
					//$xml->element('vlevel5', $category[vlevel5]);
					$xml->pop();
				}

				$xml->pop();
				return $xml->getXml();
			}else{
				$xml = new XmlWriter_();
				$xml->push('categorys');

				$xml->push('results');
				$xml->element('code', "-1");
				$xml->element('message', "카테고리 정보가 존재하지 않습니다.");
				$xml->pop();
				$xml->pop();
				return $xml->getXml();
			}
		}else{

			//$categorys = str_replace("\"true\"","true",json_encode($categorys));
			//$categorys = str_replace("\"false\"","false",$categorys);

			$RESULT["code"]="00";
			$RESULT["msg"]="";
			$RESULT["data"]=$categorys;
			return $RESULT;

		}
	}

	public function getNewContents(){

		$db = new Database;
		
		if($_SESSION["admininfo"]["admin_level"]==9){
			$sql = "select 'goods' as name , count(*) as count from shop_product where date_format(regdate,'%Y%m%d') = '".date("Ymd")."' 
			union
			select 'order' as name , count(*) as count from shop_order where date_format(date,'%Y%m%d') = '".date("Ymd")."'";
		}else{
			$sql = "select 'goods' as name , count(*) as count from shop_product where date_format(regdate,'%Y%m%d') = '".date("Ymd")."' and admin='".$_SESSION["admininfo"]["company_id"]."'
			union
			select 'order' as name , count(*) as count from shop_order where date_format(date,'%Y%m%d') = '".date("Ymd")."' and comapny_id ='".$_SESSION["admininfo"]["company_id"]."' ";
		}

		$db->query($sql);
		$infos = $db->fetchall("object");

		if($this->ResultDataType=="xml"){

			$xml = new XmlWriter_();
			$xml->push('datas', array('total'=>count($infos)));

			foreach ($infos as $info) {
				$xml->push('data');
				$xml->element('name', $info[name]);
				$xml->element('count', $info[count]);
				$xml->pop();
			}

			$xml->pop();
			return $xml->getXml();

		}else{

			$RESULT["code"]="00";
			$RESULT["msg"]="";
			$RESULT["data"]=$infos;
			return $RESULT;
		}
	}

	public function getSellerList($data){

		$db = new Database;

		$sql = "SELECT company_id,com_name FROM ".TBL_COMMON_COMPANY_DETAIL." ccd  where  ccd.com_type in ('S','A') and ccd.seller_auth = 'Y'   ";
		$db->query($sql);
		$infos = $db->fetchall("object");

		if($this->ResultDataType=="xml"){

		}else{

			$RESULT["code"]="00";
			$RESULT["msg"]="";
			$RESULT["data"]=$infos;
			$RESULT["admininfodata"]=$this->getAdminInfo($data,false);
			return $RESULT;
		}
	}

	public function getAdminInfo($data,$return_array=true){

		$db = new Database;

		$sql = "select * from ".TBL_COMMON_USER." where id=TRIM('".$data["userid"]."') and mem_type in ('S','A','MD') ";
		$db->query($sql);
		$db->fetch();

		if($db->dt["mem_type"] == "S" || $db->dt["mem_type"] == "CS" ){	// 셀러와 가맹점 회원은 레벨 8
			$infos["admin_level"] = "8";
		}else if($db->dt["mem_type"] == "A" || $db->dt["mem_type"] == "MD"){	// 직원과 관리자 MD 는 레벨 9
			$infos["admin_level"] = "9";
		}else{
			$infos["admin_level"] = "8";
		}

		if($this->ResultDataType=="xml"){

		}else{
			if($return_array){
				$RESULT["code"]="00";
				$RESULT["msg"]="";
				$RESULT["data"]=$infos;
				return $RESULT;
			}else{
				return $infos;
			}
		}
	}

	public function insertGood($goods)
	{

		//admin/mallstoryapp/server.class
		$ItemDetail = new ItemGoods();
		
		if($goods["cate3"] != "")			$ItemDetail->cid = $goods["cate3"];
		elseif($goods["cate2"] != "")		$ItemDetail->cid = $goods["cate2"];
		else											$ItemDetail->cid = $goods["cate1"];
		
		$ItemDetail->pname = $goods["goods_name"];
		$ItemDetail->pcode = $goods["goods_code"];
		$ItemDetail->coprice = $goods["price0"];
		$ItemDetail->wholesale_price = $goods["price1"];
		$ItemDetail->listprice = $goods["price2"];
		$ItemDetail->option = $goods["option"];
		$ItemDetail->basicimagefile = $goods["basicimagefile"];
		$ItemDetail->basicinfo = $goods["basicinfo"];
		$ItemDetail->origin = $goods["origin"];
		$ItemDetail->company = $goods["company"];
		$ItemDetail->company_id = $goods["store"];

		//admin/mallstoryapp/lib/product.lib.php 상품등록
		$pid = insertproduct($ItemDetail);

		if($pid){
			//admin/mallstoryapp/lib/product.lib.php 카테고리등록
			insertproductcategory($ItemDetail,$pid);

			//admin/mallstoryapp/lib/product.lib.php 옵션등록
			insertproductoption($ItemDetail,$pid);
			
			//admin/mallstoryapp/lib/product.lib.php 가격히스토리
			//insertproductprice($ItemDetail,$pid);

			//admin/mallstoryapp/lib/product.lib.php 대표이미지 및 추가이미지
			copyproductimage($ItemDetail,$pid);
			
			//admin/mallstoryapp/lib/product.lib.php 상세이미지 및 상세설명
			copyproductbasicinfo($ItemDetail,$pid);
			
			$RESULT["code"]="00";
			$RESULT["msg"]="";
			$RESULT["data"]=$pid;
			return $RESULT;
		}else{
			$RESULT["code"]="99";
			$RESULT["msg"]="insert product 오류";
			$RESULT["data"]=$pid;
			return $RESULT;
		}
	}


	protected function data_log($value){
		
		$file = fopen("../log/pos_log.txt","a+");
		fwrite($file,$value.date('h:i:s')."\n");
		fclose($file);
	}

	protected function xml_log($value){
		
		$file = fopen("../log/pos_xml_log.txt","a+");
		fwrite($file,$value."\n");
		fclose($file);
	}




}