<?
include("../class/layout.class");
include($_SERVER["DOCUMENT_ROOT"]."/include/email.send.php");

include("../sellertool/sellertool.lib.php");
include("../openapi/openapi.lib.php");

//inventoryOutputHistory,InventoryInputHistory 함수는 inventory.lib.php 으로!
include("../inventory/inventory.lib.php");

//-- 리셀러 인센티브 관련 START--
include_once($_SERVER["DOCUMENT_ROOT"]."/admin/logstory/class/sharedmemory.class");
$shmop = new Shared("reseller_rule");
$shmop->filepath = $_SERVER["DOCUMENT_ROOT"].$_SESSION["layout_config"]["mall_data_root"]."/_shared/";
$shmop->SetFilePath();
$reseller_data = $shmop->getObjectForKey("reseller_rule");
$reseller_data = unserialize(urldecode($reseller_data));
//-- 리셀러 인센티브 관련 END--

$db = new Database;
$db2 = new Database;

$oid = $_REQUEST['oid'];
$act = $_REQUEST['act'];

if ($act == "orderinfo_update"){
	$bname = trim($bname);
	$bmail = trim($bmail);
	$btel  = trim($btel);
	$rname = trim($rname);
	$rmail = trim($rmail);
	$rtel  = trim($rtel);
	$zip   = "$zipcode1-$zipcode2";
	$addr  = trim($addr);
	$bank  = trim($bank);
	$bmobile = trim($bmobile);
	$rmobile = trim($rmobile);

	if($admininfo[admin_level] == 9){
		$sql = "UPDATE ".TBL_SHOP_ORDER." SET
						bname='$bname', mem_group ='$mem_group', bmail='$bmail', btel='$btel', bmobile = '$bmobile',
						rname='$rname', rmail='$rmail', rtel='$rtel', rmobile = '$rmobile', zip='$zip', addr='$addr',bank_input_date='$bank_input_date'
						WHERE oid='$oid'";
		$db->query($sql);
	}else{
		$sql = "UPDATE ".TBL_SHOP_ORDER." SET
						bname='$bname', mem_group ='$mem_group', bmail='$bmail', btel='$btel', bmobile = '$bmobile',
						rname='$rname', rmail='$rmail', rtel='$rtel', rmobile = '$rmobile', zip='$zip', addr='$addr',bank_input_date='$bank_input_date'
						WHERE oid='$oid'";
		$db->query($sql);
	}

	echo("<script language='javascript' src='../js/message.js.php'></script><script>show_alert('주문정보가 정상적으로 수정되었습니다.');parent.location.reload();location.href='about:blank';</script>");
}


/**
 * 오더에디트에서 수정시
 */
if ($act == "update")
{
	$bname = trim($bname);
	$bmail = trim($bmail);
	$btel  = trim($btel);
	$rname = trim($rname);
	$rmail = trim($rmail);
	$rtel  = trim($rtel);
	$zip   = "$zipcode1-$zipcode2";
	$addr  = trim($addr);
	$bank  = trim($bank);
	$bmobile = trim($bmobile);
	$rmobile = trim($rmobile);
	$where_in_oid=" AND od_ix IN ( ";
	for($i=0;$i < count($od_ix);$i++){
		if($i==0) $where_in_oid.="'".$od_ix[$i]."'";
		else $where_in_oid.=",'".$od_ix[$i]."'";
	}
	$where_in_oid.=" ) ";

//******************************************************************************* 마스터 관리자 일때  START ********************************************************************************//
	if($admininfo[admin_level] == 9){
		//echo $bstatus ."!=". $status;
		//exit;
		//if($bstatus != $status){ // 현재상태정보와 변경상태가 틀릴경우만 상태변경정보 추가

            //입금대기(nothing) or 입금완료
			if($status == ORDER_STATUS_INCOM_READY || $status == ORDER_STATUS_INCOM_COMPLETE){
					if($status == ORDER_STATUS_INCOM_COMPLETE){
						$db->query("select oid, uid, rmobile, bank_input_date from ".TBL_SHOP_ORDER."  WHERE oid='".$oid."'");
						$db->fetch();
						$order = $db->dt;

						if($order[bank_input_date] == ""){
							$db->query("update ".TBL_SHOP_ORDER." set bank_input_date = '".date("Ymd")."' WHERE oid='".$oid."'");
							$db->fetch();
						}

						$sql = "select oid, hotcon_event_id, hotcon_pcode, status, pcnt from ".TBL_SHOP_ORDER_DETAIL." od WHERE oid='".$oid."'";
						//echo $sql;
						$db->query($sql);
						for($i=0;$i < $db->total;$i++){

							$db->fetch($i);
							//echo $db->dt[hotcon_pcode];
							if($db->dt[hotcon_event_id] && $db->dt[hotcon_pcode]){

								if($db->dt[status] != $status){
									CallHotCon($order[uid], $order[oid], $db->dt[pid], $db->dt[hotcon_event_id], $db->dt[hotcon_pcode], $db->dt[pcnt], $order[rmobile]);
								}
							}
						}
					}
			}
            //배송중
			if ($status == ORDER_STATUS_DELIVERY_ING){

				$db->query("select * from ".TBL_SHOP_ORDER."  WHERE oid='".$oid."'");
				$order = $db->fetch();

				$db->query("select * from ".TBL_SHOP_ORDER_DETAIL." WHERE oid='$oid' $where_in_oid");
				$order_details = $db->fetchall();

                if($order_details[order_from] == 'self'){
    				$mail_info[mem_name] = $order[bname];
    				$mail_info[mem_mail] = $order[bmail];
    				$mail_info[mem_id] = $order[bname];
    				$mail_info[mem_mobile] = $order[bmobile];

    				sendMessageByStep('good_send_sucess', $mail_info);
                }

            //입금완료
			}else if($status == ORDER_STATUS_INCOM_COMPLETE){
				$db->query("select * from ".TBL_SHOP_ORDER."  WHERE oid='".$oid."'");
				$order = $db->fetch();

				$db->query("select * from ".TBL_SHOP_ORDER_DETAIL." WHERE oid='$oid' $where_in_oid");
				$order_details = $db->fetchall();

                if($order_details[order_from] == 'self'){
    				$mail_info[mem_name] = $order[bname];
    				$mail_info[mem_mail] = $order[bmail];
    				$mail_info[mem_id] = $order[bname];
    				$mail_info[mem_mobile] = $order[bmobile];

    				sendMessageByStep('payment_bank_apply', $mail_info);
                }

            //취소완료
			}else if ($status == ORDER_STATUS_CANCEL_COMPLETE){// 취소일경우
				$db->query("select * from ".TBL_SHOP_ORDER."  WHERE oid='".$oid."'");
				$order = $db->fetch();
				//$db->query("UPDATE ".TBL_SHOP_RESERVE_INFO."  Set state = '".RESERVE_STATUS_ORDER_CANCEL."' WHERE oid = '$oid'");
				//$db->query("UPDATE shop_baymoney_info  Set state = '".BAYMONEY_STATUS_ORDER_CANCEL."' WHERE oid = '$oid'");

				$udb = new Database;
				/*
				$db->query("select * from ".TBL_SHOP_ORDER_DETAIL." WHERE oid='$oid'");

				for($i=0;$i < $db->total;$i++){
					$db->fetch($i);
					if($select_option_id != 0){
						// 옵션 코드값이 있는 경우에 옵션이 가격/재고 관리 옵션인지 'b' 판단해서  가격/재고 관리 옵션일경우 옵션의 재고수량도 증가시켜준다
						$udb->query("select po.id,option_stock,option_safestock from  ".TBL_SHOP_PRODUCT_OPTIONS." pos, ".TBL_SHOP_PRODUCT_OPTIONS_DETAIL." po  WHERE id = '".$select_option_id."' and pos.opn_ix = po.opn_ix and pos.option_kind = 'b'");
						if($udb->total){
							$udb->fetch($i);
							$udb->query("UPDATE ".TBL_SHOP_PRODUCT_OPTIONS_DETAIL."  Set option_stock = option_stock + ".$pcnt." WHERE id = '".$udb->dt[id]."'");
							if(($udb->dt[option_stock] +1) > $udb->dt[option_safestock]){
								$stock_update = " , option_stock_yn = 'N' ";
							}else if(($udb->dt[option_stock] +1) < $udb->dt[option_safestock]){
								$stock_update = " , option_stock_yn = 'S' ";
							}
						}

					}
					$udb->query("UPDATE ".TBL_SHOP_PRODUCT."  Set stock = stock + ".$pcnt." $stock_update WHERE id = '".$db->dt[pid]."'");
				}
				*/
				$db->query("select * from ".TBL_SHOP_ORDER_DETAIL." WHERE oid='$oid' $where_in_oid");
				$order_details = $db->fetchall();

				if($order_details[order_from] == 'self'){
                    $mail_info[mem_name] = $order[bname];
    				$mail_info[mem_mail] = $order[bmail];
    				$mail_info[mem_id] = $order[bname];
    				$mail_info[mem_mobile] = $order[bmobile];

    				sendMessageByStep('order_cancel', $mail_info);
                }

				echo("<script language='javascript' src='../_language/language.php'></script><script>alert(language_data['orders.act.php']['A'][language]);</script>");//카드결제일 경우 [승인취소] 작업도 해주세요.

            // 환불완료일때
            }else if ($status == ORDER_STATUS_REFUND_COMPLETE){
				/*$db->query("select * from ".TBL_SHOP_ORDER."  WHERE oid='".$oid."'");
				$order = $db->fetch();*/
				//$db->query("UPDATE ".TBL_SHOP_RESERVE_INFO."  Set state = '".RESERVE_STATUS_ORDER_CANCEL."' WHERE oid = '$oid'");
				//$db->query("UPDATE shop_baymoney_info  Set state = '".BAYMONEY_STATUS_ORDER_CANCEL."' WHERE oid = '$oid'");

				//$udb = new Database;
				/*
				$db->query("select * from ".TBL_SHOP_ORDER_DETAIL." WHERE oid='$oid'");

				for($i=0;$i < $db->total;$i++){
					$db->fetch($i);
					if($select_option_id != 0){
						// 옵션 코드값이 있는 경우에 옵션이 가격/재고 관리 옵션인지 'b' 판단해서  가격/재고 관리 옵션일경우 옵션의 재고수량도 증가시켜준다
						$udb->query("select po.id,option_stock,option_safestock from  ".TBL_SHOP_PRODUCT_OPTIONS." pos, ".TBL_SHOP_PRODUCT_OPTIONS_DETAIL." po  WHERE id = '".$select_option_id."' and pos.opn_ix = po.opn_ix and pos.option_kind = 'b'");
						if($udb->total){
							$udb->fetch($i);
							$udb->query("UPDATE ".TBL_SHOP_PRODUCT_OPTIONS_DETAIL."  Set option_stock = option_stock + ".$pcnt." WHERE id = '".$udb->dt[id]."'");
							if(($udb->dt[option_stock] +1) > $udb->dt[option_safestock]){
								$stock_update = " , option_stock_yn = 'N' ";
							}else if(($udb->dt[option_stock] +1) < $udb->dt[option_safestock]){
								$stock_update = " , option_stock_yn = 'S' ";
							}
						}

					}
					$udb->query("UPDATE ".TBL_SHOP_PRODUCT."  Set stock = stock + ".$pcnt." $stock_update WHERE id = '".$db->dt[pid]."'");
				}
				*/
				/*$db->query("select * from ".TBL_SHOP_ORDER_DETAIL." WHERE oid='$oid'");
				$order_details = $db->fetchall();

				$mail_info[mem_name] = $bname;
				$mail_info[mem_mail] = $bmail;
				$mail_info[mem_id] = $bname;
				$mail_info[mem_mobile] = $bmobile;

				sendMessageByStep('order_cancel', $mail_info);*/

				echo("<script language='javascript' src='../_language/language.php'></script><script>alert(language_data['orders.act.php']['A'][language]);</script>");//카드결제일 경우 [승인취소] 작업도 해주세요.

			}
		//}

        if($status == ORDER_STATUS_DELIVERY_ING){
            //해당 주문번호의 품목 전부 배송인지 체크
            $check_flag = checkDlvIsAll($oid, count($od_ix));
            if(!empty($check_flag)){
                if($check_flag == TRUE){
                    $dlv_kind = 'all';
                }else{
                    $dlv_kind = 'part';
                }
            }else{
                $dlv_kind = NULL;
            }
        }

        //hidden으로 TRUE값이며 오더에디트 form에만 있음
		if ($product_status_change){// 상품상태 변경 체크시 각각의 상품에 대한 상태 변경이 된다
			if($deliverycode){
				if($status == ORDER_STATUS_EXCHANGE_AGAIN_DELIVERY){
					$deliverycode_string = " ,  return_invoice_no='$deliverycode',return_quick = '$quick' " ;
				}else{
					$deliverycode_string = " ,  invoice_no='$deliverycode',quick = '$quick' " ;
				}
			}

			$udb = new Database;
			$db->debug = true;
			$udb->debug = true;
            $send_sellertool = true;

			for($i=0;$i < count($od_ix);$i++){
				$db->query("select * from ".TBL_SHOP_ORDER_DETAIL." where  od_ix ='".$od_ix[$i]."' ");//oid='$oid' and
				$db->fetch();
				$order_detail_info = $db->dt;
				$pid = $db->dt[pid];
				$oid = $db->dt[oid];
				$ptprice = $db->dt[ptprice];
				$pcnt = $db->dt[pcnt];
				$select_option_id = $db->dt[option1];
				$di_date = $db->dt[di_date];
				$stock_use_yn = $db->dt[stock_use_yn];

                $db_update = TRUE; //db업데이트 여부(제휴사 상태변경 실패시 false)

				 //배송준비중 처리(제휴사)
                if($db->dt[status] != $status && $status == ORDER_STATUS_DELIVERY_READY){

                    //결제완료 상태인경우 제휴사 배송준비중 처리 가능
                    if($order_detail_info[status] == "IC"){

                        //자사주문
                        if($order_detail_info[order_from] == 'self'){
                            //nothing

                        /**
                         * 제휴사 배송준비중 처리
                         */
                        }else{
							if(SELLER_TOOL_USE){
								$subDb = new Database;
								$sql = "select * from sellertool_order_info where order_id = '".$oid."' and order_detail_ix = '".$order_detail_info[od_ix]."'";
								$subDb->query($sql);
								if($subDb->total){
									$sub_info = $subDb->fetch();
									$result = sendOrdRepackaging($order_detail_info[order_from], $sub_info[target_ordNo], $sub_info[ordPrdSeq], $sub_info[addPrdYn], $sub_info[addPrdNo], $sub_info[dlvNo]);

									if(!empty($result)){
										if($result->resultCode ==  '0'){
											$db_update = TRUE;
										}else{
											$db_update = FALSE;
										}
										$status_message = "제휴사(".$order_detail_info[order_from].")-".$result->message;
									}else{
										$db_update = FALSE;
										$status_message = "제휴사(".$order_detail_info[order_from].")-배송준비중 처리 실패";
									}
									//로그남기기
									$subDb->sequences = "".TBL_SHOP_ORDER_STATUS."_SEQ";
									$subDb->query("insert into ".TBL_SHOP_ORDER_STATUS." (os_ix, oid, pid, status, status_message, admin_message, company_id,quick,invoice_no, regdate ) values ('','$oid','".$pid."','$status','$status_message','$admin_message','".$admininfo[company_id]."','$quick','$deliverycode',NOW())");
								}
							}
                        }
                    }
                //배송완료 처리(자사)
                }else if($db->dt[status] != $status && $status == ORDER_STATUS_DELIVERY_COMPLETE){	//xuefeng1(배송완료 마일리지 적립)

					$dc_date_str = " , dc_date = NOW() ";

					//////////////// 마일리지 적립 시작///////////////////////
					$sql = "select uid from ".TBL_SHOP_ORDER." where oid = '".$oid."'";
					$db->query($sql);
					$db->fetch();
					$uid = $db->dt[uid];
					InsertReserveInfo($uid,$oid,$order_detail_info[od_ix],$id,$reserve,'1','1',$etc,'mileage','b2c',$admininfo);	//마일리지,적립금 통합용 함수 2013-06-19 이학봉
					//////////////// 마일리지 적립 끝///////////////////////

					//$db->query("update ".TBL_SHOP_RESERVE_INFO." set state = '".RESERVE_STATUS_COMPLETE."' WHERE oid='$oid' and state = '".RESERVE_STATUS_READY."' and pid = '$pid' ");
					
					//----------------------------------------리셀러 배송완료시 인센티브 적용 START---------------------------------------------//
					if($reseller_data[rsl_use] == "y"){

						$db->query("select uid as flowin_code from shop_order where oid ='".$oid."' ");
						$db->fetch();

						$flowin_code = $db->dt[flowin_code];

						$db->query("select rsl_code from reseller_flowin_detail where flowin_code ='".$flowin_code."' ");
						$db->fetch();

						$rsl_code = $db->dt[rsl_code];

						if($db->total){//유입회원이라면

							$db->query("select count(*) as first_order from reseller_incentive where flowin_code='".$flowin_code."' and incentive_type = '2'");
							$db->fetch();
							$first_order = $db->dt[first_order]; //첫구매여부


							$db2->query("SELECT id FROM reseller_dropmember where rsl_code='".$rsl_code."'");


							if(!$db2->total){//탈퇴한 리셀러가 아니라면

								$db2->query("SELECT * FROM reseller_policy where rsl_code='".$rsl_code."'");
								$db2->fetch();

								$new_incentive_type = $db2->dt[new_incentive_type];
								$new_incentive_after = $db2->dt[new_incentive_after];
								$incentive_type = $db2->dt[incentive_type];
								$incentive_rate = $db2->dt[incentive_rate];

								//첫구매시
								if($first_order == 0 ){
									//신규회원 유도 첫구매시 설정했을때
									if($new_incentive_type == '3'){
										$db->sequences = "RESELLER_INCENTIVE_SEQ";
										$db->query("insert into reseller_incentive (incentive_ix,rsl_code, flowin_code, regdate, incentive, incentive_type, oid, od_ix, incentive_rate) values ('','".$rsl_code."','".$flowin_code."',NOW(),'".$new_incentive_after."','2','".$oid."','".$od_ix[$i]."','0')");
									}
								//첫구매가 아니라면
								}elseif($first_order != 0){
									//매출액 인센티브 사용할때
									if($incentive_type == '2'){
										$incentive = $ptprice * $incentive_rate / 100;
										$db->sequences = "RESELLER_INCENTIVE_SEQ";
										$db->query("insert into reseller_incentive (incentive_ix,rsl_code, flowin_code, regdate, incentive, incentive_type, oid, od_ix, incentive_rate) values ('','".$rsl_code."','".$flowin_code."',NOW(),'".$incentive."','2','".$oid."','".$od_ix[$i]."','".$incentive_rate."')");
									}
								}
							}
						}
					}
					//-----------------------------------------------리셀러 배송완료시 인센티브 적용 END---------------------------------------//

				}else if($db->dt[status] != $status && $status == ORDER_STATUS_AIR_TRANSPORT_ING){
					if($_SESSION["layout_config"]["mall_use_inventory"] == "Y"){
						if($order_detail_info[product_type]!='0'){ //해외 물류는 항공 배송중에서 재고차감
							inventoryOutputHistory($order_detail_info, '항공배송중 출고');
						}
					}
                //배송중 처리
				}else if($db->dt[status] != $status && $status == ORDER_STATUS_DELIVERY_ING){


                    //*************************************************************** 제휴사 배송중(발송) 처리 START ***************************************************************//
                    /**
                     * {bool}send_sellertool = 전체배송인경우 배송처리후 false처리하여 루프내에서 한번만 처리되도록한다. true인경우 부분배송으로 간주하여 상품별로 배송처리
                     * default값 true
                     */
                    if($order_detail_info[status] == "DR" && $send_sellertool == TRUE){//배송준비중일때 가능하도록
                        //자사주문
                        if($order_detail_info[order_from] == 'self'){
                            //nothing

                        /**
                         * 제휴사 배송중 처리
                         */
                        }else{
							if(SELLER_TOOL_USE){
								$send_date = date('YmdHi');
								$dlvMthdCd = $_POST['dlvMthdCd'];
								$dlvMthdCd = '01'; //택배
								$dlv_com_code = $_POST['quick'];
								$invcNo = $_POST['invcNo'];

								$subDb = new Database;
								$sql = "select * from sellertool_order_info where order_id = '".$oid."' and order_detail_ix = '".$order_detail_info[od_ix]."'";
								$subDb->query($sql);
								if($subDb->total){
									$sub_info = $subDb->fetch();

									if($dlv_kind == 'all'){
										//배송업체 코드 변환
										$dlvEtprsCd = getLinkedDlvCode($order_detail_info[order_from], $dlv_com_code);

										$result = sendOrdReqDelivery($order_detail_info[order_from], $send_date, $dlvMthdCd, $dlvEtprsCd, $invcNo, $sub_info[dlvNo]);

										if(!empty($result)){
											if($result->resultCode ==  '0'){
												$db_update = TRUE;
											}else{
												$db_update = FALSE;
											}
											$send_sellertool = FALSE;//주문상품 전체배송처리이므로 더이상 제휴사에 배송처리 안하도록

											$status_message = "제휴사(".$order_detail_info[order_from].")-".$result->message;

										}else{
											$db_update = FALSE;
											$status_message = "제휴사(".$order_detail_info[order_from].")-배송처리 실패";
										}
										//로그남기기
										$subDb->sequences = "SHOP_ORDER_STATUS_SEQ";
										$subDb->query("insert into ".TBL_SHOP_ORDER_STATUS." (os_ix, oid, pid, status, status_message, admin_message, company_id,quick,invoice_no, regdate ) values ('','$oid','".$pid."','$status','$status_message','$admin_message','".$admininfo[company_id]."','$quick','$deliverycode',NOW())");


									}else if($dlv_kind == 'part'){
										//배송업체 코드 변환
										$dlvEtprsCd = getLinkedDlvCode($order_detail_info[order_from], $dlv_com_code);

										$result = sendOrdReqPartDelivery($order_detail_info[order_from], $send_date, $dlvMthdCd, $dlvEtprsCd, $invcNo, $sub_info[dlvNo], $sub_info[target_ordNo], $sub_info[ordPrdSeq]);

										if(!empty($result)){
											if($result->resultCode ==  '0'){
												$db_update = TRUE;
											}else{
												$db_update = FALSE;
											}
											$status_message = "제휴사(".$order_detail_info[order_from].") 부분발송-".$result->message;

										}else{
											$db_update = FALSE;
											$status_message = "제휴사(".$order_detail_info[order_from].") 부분발송-처리 실패";
										}
										//로그남기기
										$subDb->sequences = "SHOP_ORDER_STATUS_SEQ";
										$subDb->query("insert into ".TBL_SHOP_ORDER_STATUS." (os_ix, oid, pid, status, status_message, admin_message, company_id,quick,invoice_no, regdate ) values ('','$oid','".$pid."','$status','$status_message','$admin_message','".$admininfo[company_id]."','$quick','$deliverycode',NOW())");
									}
								}
							}
                        }

                    }
                    //*************************************************************** 제휴사 배송중(부분 발송) 처리 END *****************************************************************//

                    //재고 빼는 부분
					$di_date_str = " , di_date = NOW() ";
					/*inventoryOutputHistory 함수안에 있음
					if($di_date == ""){
						if ($stock_use_yn == "Y"){
							$db->query("UPDATE ".TBL_SHOP_PRODUCT."  Set sell_ing_cnt = sell_ing_cnt - ".$pcnt.", stock = stock - ".$pcnt."  WHERE id = '".$pid."'");
							if($select_option_id != 0){
								$db->query("update ".TBL_SHOP_PRODUCT_OPTIONS_DETAIL." set option_sell_ing_cnt = option_sell_ing_cnt - ".$pcnt.", option_stock = option_stock - ".$pcnt." where pid = '$pid' and id ='$select_option_id' ");
								$db->query("SELECT option_stock , option_safestock FROM ".TBL_SHOP_PRODUCT_OPTIONS_DETAIL." WHERE pid = '$pid' and id ='$select_option_id' ");
								if($db->total){
										$db->fetch();

										if($db->dt[option_stock] <= 0){
											$db->query("update ".TBL_SHOP_PRODUCT." set option_stock_yn = 'N' where id ='$pid'"); // 품절
										}else if($db->dt[option_stock] < $db->dt[option_safestock]){
											$db->query("update ".TBL_SHOP_PRODUCT." set option_stock_yn = 'R' where id ='$pid'");  // 재고부족
										}
								}
							}
						}
					}
					*/
                    // 이거 안쓰는듯?
                    /**
					if($order["escrow_yn"]=="Y") {//에스크로 사용 시 pg 상점관리자에 자동으로 배송시작 업데이트 kbk 12/03/12
						$db2->query("SELECT COUNT(od_ix) AS od_ix_cnt FROM ".TBL_SHOP_ORDER_DETAIL." WHERE oid='".$oid."' AND invoice_no!='' ");
						$db2->fetch();
						if($db2->dt["od_ix_cnt"]<1) {
							$db2->query("SELECT sattle_module FROM ".TBL_SHOP_SHOPINFO." WHERE mall_ix = '".$admininfo[mall_ix]."' and mall_div = '".$admininfo[mall_div]."'  ");
							$db2->fetch();
							$p_sattle_module=$db2->dt["sattle_module"];
							if($p_sattle_module=="kcp") {
								$db2->query("SELECT kcp_id,kcp_key,kcp_type FROM ".TBL_SHOP_SHOPINFO." WHERE mall_ix = '".$admininfo[mall_ix]."' and mall_div = '".$admininfo[mall_div]."'  ");
								$db2->fetch();
								$site_cd=$db2->dt["kcp_id"];
								$site_key=$db2->dt["kcp_key"];
								$kcp_type=$db2->dt["kcp_type"];
								//$site_name=$_SESSION["admininfo"]["company_name"];
								$_POST["ordr_idxx"]=$oid;
								$_POST["req_tx"]="mod_escrow";
								$_POST["mod_type"]="STE1";
								$_POST["mod_desc"]="";
								$_POST["tno"]=$order["tid"];
								$_POST["deli_numb"]=$deliverycode;
								$_POST["deli_corp"]=codeName($quick);
								$_POST["vcnt_yn"]="N";

								$db2->query("SELECT com_name FROM common_company_detail WHERE com_type='A' ");
								$db2->fetch();
								$site_name=$db2->dt["com_name"];
								//$mode=1;
							}

							$pg_com_dir = $p_sattle_module;
							///*echo $site_cd."<br />".$site_key."<br />".$kcp_type."<br />".$site_name."<br />".$_POST["ordr_idxx"]."<br />".$_POST["req_tx"]."<br />".$_POST["mod_type"]."<br />".$_POST["tno"]."<br />".$_POST["deli_numb"]."<br />".$_POST["deli_corp"]."<br />".$pg_com_dir;
							//exit;
							include($DOCUMENT_ROOT."/shop/$pg_com_dir/card.lib.php");
							exit; //TODO: !!!!!! 이거뭐임? 에스크로면 상점 관리자에서는 db업데이트 안함? !!!!!!
						}
					}
                    */

					/////////////////////////////////////////////////////////////////////////////////////////////////////재고관리 사용할때 출고 리스트에 재고 정보 남기기////////////////////////////////////////////////////////////////////////////////////////
					//echo "배송중 출고";
					//xuefeng test
					if($_SESSION["layout_config"]["mall_use_inventory"] == "Y"){
						if($order_detail_info[product_type]=='0'){ //해외 물류는 항공 배송중에서 재고차감
							//inventoryOutputHistory($order_detail_info, '배송중 출고');

							$item_info[pi_ix] = $_POST["now_pi_ix"]; // 입출고 내역은 어디로 이동해 갔는지가 남기 때문에 move_pi_ix 기록만 남긴다.
							$item_info[ps_ix] = $_POST["now_ps_ix"]; // 이동출고장소
							$item_info[company_id] = $_POST["now_company_id"]; // 이동사업장
							$item_info[h_div] = "2";  // 입출고유형 2 :  출고
							$item_info[vdate] = date("Ymd");
							$item_info[ci_ix] = $_POST["ci_ix"]; // 거래처
							$item_info[oid] = $_POST["oid"];
							$item_info[msg] = $_POST["etc"];
							$item_info[h_type] = $_POST["h_type"];
							$item_info[charger_name] = $_SESSION[admininfo]["charger"];
							$item_info[charger_ix] = $_SESSION[admininfo]["charger_ix"];
							$item_info[detail] = $warehouse_moveinfo;
							//UpdateGoodsItemStockInfo($order_detail_info, $db);
						}
					}
					UpdateProductCnt_complete($order_detail_info);//빠른 재고 관리 전용 주문진행 중 수량 차감 inventoryOutputHistory 함수 안에 있음 kbk 13/06/20

				}else if($db->dt[status] != $status && $status == ORDER_STATUS_CANCEL_COMPLETE){	//xuefeng2(주문취소)
					// 주문취소 완료시 적립금 적립 취소
					
					//////////////// 마일리지 적립 시작///////////////////////
					$sql = "select uid from ".TBL_SHOP_ORDER." where oid = '".$oid."'";
					$db->query($sql);
					$db->fetch();
					$uid = $db->dt[uid];
					InsertReserveInfo($uid,$oid,$order_detail_info[od_ix],$id,$reserve,'9','2',$etc,'mileage','b2c',$admininfo);	//마일리지,적립금 통합용 함수 2013-06-19 이학봉
					//////////////// 마일리지 적립 끝///////////////////////

					//$db->query("update ".TBL_SHOP_RESERVE_INFO." set state = '".RESERVE_STATUS_ORDER_CANCEL."' WHERE oid='$oid' and pid = '$pid' and state = '".RESERVE_STATUS_READY."' ");

					UpdateSellingCnt($order_detail_info);
					/*UpdateSellingCnt 함수로 이동 inventory.lib.php로
					if($stock_use_yn == "Y"){
						if($select_option_id != 0){
							// 옵션 코드값이 있는 경우에 옵션이 가격/재고 관리 옵션인지 'b' 판단해서  가격/재고 관리 옵션일경우 옵션의 재고수량도 증가시켜준다
							$udb->query("select po.id,pos.opn_ix, option_stock,option_safestock,po.option_div,pos.option_name from  ".TBL_SHOP_PRODUCT_OPTIONS." pos, ".TBL_SHOP_PRODUCT_OPTIONS_DETAIL." po  WHERE id = '".$select_option_id."' and pos.opn_ix = po.opn_ix and pos.option_kind = 'b'");
							if($udb->total){
								$udb->fetch();

								//주문취소시 판매진행중 재고만 감소하기 때문에 실재 재고는 변경이 없다. 따라서 재고여부도 변경되지 않는다.
								$udb->query("UPDATE ".TBL_SHOP_PRODUCT_OPTIONS_DETAIL."  Set option_sell_ing_cnt = option_sell_ing_cnt - ".$pcnt."  WHERE id = '".$udb->dt[id]."'");
							}
						}
						$udb->query("UPDATE ".TBL_SHOP_PRODUCT."  Set sell_ing_cnt = sell_ing_cnt - ".$pcnt."  WHERE id = '".$db->dt[pid]."'");
					}
					*/
					$udb->query("update ".TBL_SHOP_ORDER." set order_cancel_price = order_cancel_price + ".$ptprice." where oid = '$oid' ");

				}else if($db->dt[status] != $status && $status == ORDER_STATUS_RETURN_COMPLETE){	//xuefeng3(반품)
					// 주문취소 완료시 적립금 적립 취소

					//////////////// 마일리지 적립 시작///////////////////////		반품일경우 반품 마일리지 확인필요
					$sql = "select uid from ".TBL_SHOP_ORDER." where oid = '".$oid."'";
					$db->query($sql);
					$db->fetch();
					$uid = $db->dt[uid];
					InsertReserveInfo($uid,$oid,$order_detail_info[od_ix],$id,$reserve,'1','3',$etc,'mileage','b2c',$admininfo);	//마일리지,적립금 통합용 함수 2013-06-19 이학봉
					//////////////// 마일리지 적립 끝///////////////////////

					//
					//$db->query("update ".TBL_SHOP_RESERVE_INFO." set state = '".RESERVE_STATUS_ORDER_CANCEL."' WHERE oid='$oid' and pid = '$pid' and state = '".RESERVE_STATUS_READY."' ");
					/*InventoryInputHistory 함수안에서 처리
					if($select_option_id != 0){
						// 옵션 코드값이 있는 경우에 옵션이 가격/재고 관리 옵션인지 'b' 판단해서  가격/재고 관리 옵션일경우 옵션의 재고수량도 증가시켜준다
						$udb->query("select po.id,option_stock,option_safestock,po.option_div,pos.option_name from  ".TBL_SHOP_PRODUCT_OPTIONS." pos, ".TBL_SHOP_PRODUCT_OPTIONS_DETAIL." po  WHERE id = '".$select_option_id."' and pos.opn_ix = po.opn_ix and pos.option_kind = 'b'");
						if($udb->total){
							$udb->fetch();

							if(($udb->dt[option_stock] + $pcnt) <= 0 ){
								$stock_update = " , option_stock_yn = 'N' ";
							}else if(($udb->dt[option_stock] + $pcnt) < $udb->dt[option_safestock]){
								$stock_update = " , option_stock_yn = 'R' ";
							}
							$option_text = $udb->dt[option_name]." : ".$udb->dt[option_div];
							$option_id = $udb->dt[id];
							$udb->query("UPDATE ".TBL_SHOP_PRODUCT_OPTIONS_DETAIL."  Set option_stock = option_stock + ".$pcnt." WHERE id = '".$udb->dt[id]."'");
						}
					}
					$udb->query("UPDATE ".TBL_SHOP_PRODUCT."  Set stock = stock + ".$pcnt." $stock_update WHERE id = '".$db->dt[pid]."'");
					*/
					$udb->query("update ".TBL_SHOP_ORDER." set order_return_price = order_return_price + ".$ptprice." where oid = '$oid' ");
					/////////////////////////////////////////////////////////////////////////////////////////////////////재고관리 사용할때 출고 리스트에 재고 정보 남기기//////////////////////////////////////////////////////////////////////////////////////////
					if($_SESSION["layout_config"]["mall_use_inventory"] == "Y"){
						InventoryInputHistory($order_detail_info,"RC","반품완료후 입고");
					}
					UpdateProductCnt_cancel($order_detail_info);//빠른 재고 관리 전용 주문진행 중 수량 증가 InventoryInputHistory 함수 안에 kbk 13/06/20

				//----------------------------------------리셀러 환불완료 인센티브 취소 START---------------------------------------------//

						$db->query("select uid as flowin_code from shop_order where oid ='".$oid."' ");
						$db->fetch();

						$flowin_code = $db->dt[flowin_code];

						$db->query("select rsl_code from reseller_flowin_detail where flowin_code ='".$flowin_code."' ");
						$db->fetch();

						$rsl_code = $db->dt[rsl_code];


						if($db->total){//유입회원이라면

							$db2->query("SELECT id FROM reseller_dropmember where rsl_code='".$rsl_code."'");

							if(!$db2->total){//탈퇴한 리셀러가 아니라면

								$db2->query("SELECT * FROM reseller_incentive where od_ix='".$od_ix[$i]."'");
								$db2->fetch();

								$incentive = -$db2->dt[incentive];//뺴기
								$incentive_rate = $db2->dt[incentive_rate];

								$db->sequences = "RESELLER_INCENTIVE_SEQ";
								$db->query("insert into reseller_incentive (incentive_ix,rsl_code, flowin_code, regdate, incentive, incentive_type, oid, od_ix, incentive_rate) values ('','".$rsl_code."','".$flowin_code."',NOW(),'".$incentive."','2','".$oid."','".$od_ix[$i]."','".$incentive_rate."')");
							}
						}

				//------------------------------------------리셀러 환불완료 인센티브 취소 END---------------------------------------------//

				}else if($db->dt[status] != $status && $status == ORDER_STATUS_SOLDOUT_CANCEL){
				    //품절취소 = 제휴사 판매불가 처리
				}else{
					$dc_date_str = "";
				}

                /**
                 * 상태변경 db입력부분(마스터)
                 *
                 */
                if($db_update){

					if($status== ORDER_STATUS_DELIVERY_ING){
						if($order_detail_info[status] == ORDER_STATUS_AIR_TRANSPORT_ING) $deliverycode_string= "";
						if($order_detail_info[status] == ORDER_STATUS_AIR_TRANSPORT_ING) $quick= "";
						if($order_detail_info[status] == ORDER_STATUS_AIR_TRANSPORT_ING) $deliverycode= "";
					}


					//거부사유 입력으로 인하여 변경
					$status_message=trim($status_message);
					if($status_message =="") {
    					$status_message = $admininfo[charger]."(".$admininfo[charger_id].")";
					}
    				if($status != ORDER_STATUS_INCOM_READY || $status != ORDER_STATUS_INCOM_COMPLETE){
						$db->sequences = "SHOP_ORDER_STATUS_SEQ";
    					$db->query("insert into ".TBL_SHOP_ORDER_STATUS." (os_ix, oid, pid, status, status_message, admin_message, company_id,quick,invoice_no, regdate ) values ('','$oid','".$pid."','$status','$status_message','$admin_message','".$admininfo[company_id]."','$quick','$deliverycode',NOW())");
    				}else{
    					$dc_date_str = "";
    				}
    				$db->query("UPDATE ".TBL_SHOP_ORDER_DETAIL." SET status = '$status' $deliverycode_string $dc_date_str $di_date_str WHERE od_ix ='".$od_ix[$i]."' ");//oid='$oid' and

    				/*$status_message = $admininfo[charger]."(".$admininfo[charger_id].")";
    				if($status != ORDER_STATUS_INCOM_READY || $status != ORDER_STATUS_INCOM_COMPLETE){
    					$db->query("insert into ".TBL_SHOP_ORDER_STATUS." (os_ix, oid, pid, status, status_message, company_id, regdate ) values ('','$oid','".$pid."','$status','$status_message','".$admininfo[company_id]."',NOW())");
    				}*/

    				$admin_message=trim($admin_message);
    				//if($admin_message!="") {
    					$db->query("UPDATE ".TBL_SHOP_ORDER_DETAIL." SET admin_message = '$admin_message' WHERE od_ix ='".$od_ix[$i]."' ");
    				//}
                }
			}

			if($status == ORDER_STATUS_CANCEL_COMPLETE){
				$sql = "select
				        sum(case when oid='$oid' then 1 else 0 end) as whole_total ,
				        sum(case when company_id ='".$admininfo[company_id]."' then 1 else 0 end) as admin_total ,
				        sum(case when company_id != '".$admininfo[company_id]."' then 1 else 0 end) as etc_total ,
				        sum(case when status = '$status' then 1 else 0 end) as status_total
				        from ".TBL_SHOP_ORDER_DETAIL." WHERE oid='$oid'";
				$db->query($sql);
				$db->fetch();
				$whole_total = $db->dt[whole_total];
				$admin_total = $db->dt[admin_total];
				$etc_total = $db->dt[etc_total];
				$status_total = $db->dt[status_total];

				if(count($od_ix) == $whole_total || $whole_total == $status_total){
					$udb->query("UPDATE ".TBL_SHOP_ORDER." SET status = '$status'  WHERE oid ='".$oid."' ");
					$db->query("UPDATE ".TBL_SHOP_RESERVE_INFO."  Set state = '".RESERVE_STATUS_ORDER_CANCEL."' WHERE oid = '$oid'");
				}
			}

		}
//******************************************************************************* 마스터 관리자  END ********************************************************************************//

//******************************************************************************* 셀러 일때  START ***************************************************************************************//
	}else if($admininfo[admin_level] == 8){


			if($deliverycode){
				$deliverycode_string = " ,  invoice_no='$deliverycode',quick = '$quick' " ;
			}

			$udb = new Database;

			for($i=0;$i < count($od_ix);$i++){
				//echo ("UPDATE ".TBL_SHOP_ORDER_DETAIL." SET invoice_no='$deliverycode' WHERE oid='$oid' and pid ='".$pid[$i]."' ");
				$db->query("select * from ".TBL_SHOP_ORDER_DETAIL." where  od_ix ='".$od_ix[$i]."' ");//oid='$oid' and
				$db->fetch();
				$order_detail_info = $db->dt;
				$pid = $db->dt[pid];
				$ptprice = $db->dt[ptprice];
				$pcnt = $db->dt[pcnt];
				$select_option_id = $db->dt[option1];
				$stock_use_yn = $db->dt[stock_use_yn];
				$di_date = $db->dt[di_date];

                //배송완료
				if($db->dt[status] != $status && $status == ORDER_STATUS_DELIVERY_COMPLETE){//xuefeng10 (배송완료)

					//////////////// 마일리지 적립 시작///////////////////////		반품일경우 반품 마일리지 확인필요
					$sql = "select uid from ".TBL_SHOP_ORDER." where oid = '".$oid."'";
					$db->query($sql);
					$db->fetch();
					$uid = $db->dt[uid];
					InsertReserveInfo($uid,$oid,$order_detail_info[od_ix],$id,$reserve,'1','1',$etc,'mileage','b2c',$admininfo);	//마일리지,적립금 통합용 함수 2013-06-19 이학봉
					//////////////// 마일리지 적립 끝///////////////////////

					$dc_date_str = " , dc_date = NOW() ";
					//$db->query("update ".TBL_SHOP_RESERVE_INFO." set state = '".RESERVE_STATUS_COMPLETE."' WHERE oid='$oid' and state = '".RESERVE_STATUS_READY."' and pid = '$pid' ");

				}else if($db->dt[status] != $status && $status == ORDER_STATUS_AIR_TRANSPORT_ING){
					if($_SESSION["layout_config"]["mall_use_inventory"] == "Y"){
						if($order_detail_info[product_type]!='0'){ //해외 물류는 항공 배송중에서 재고차감
							inventoryOutputHistory($order_detail_info, '항공배송중 출고');
						}
					}
                //배송중
                }else if($db->dt[status] != $status && $status == ORDER_STATUS_DELIVERY_ING){
					$di_date_str = " , di_date = NOW() ";

					/*inventoryOutputHistory 함수 안에있음
					if($di_date == ""){
						if ($stock_use_yn == "Y"){
							$db->query("UPDATE ".TBL_SHOP_PRODUCT."  Set sell_ing_cnt = sell_ing_cnt - ".$pcnt.", stock = stock - ".$pcnt."  WHERE id = '".$pid."'");
						}
					}
					if($select_option_id != 0){
						if($stock_use_yn == "Y"){
								$db->query("update ".TBL_SHOP_PRODUCT_OPTIONS_DETAIL." set option_sell_ing_cnt = option_sell_ing_cnt - ".$pcnt.", option_stock = option_stock - ".$pcnt."  where pid = '$pid' and id ='$select_option_id' ");
								$db->query("SELECT option_stock , option_safestock FROM ".TBL_SHOP_PRODUCT_OPTIONS_DETAIL." WHERE pid = '$pid' and id ='$select_option_id' ");
								if($db->total){
										$db->fetch();

										if($db->dt[option_stock] <= 0){
											$db->query("update ".TBL_SHOP_PRODUCT." set option_stock_yn = 'N' where id ='$pid'"); // 품절
										}else if($db->dt[option_stock] < $db->dt[option_safestock]){
											$db->query("update ".TBL_SHOP_PRODUCT." set option_stock_yn = 'R' where id ='$pid'");  // 재고 부족
										}
								}
						}
					}
					*/


					if($_SESSION["layout_config"]["mall_use_inventory"] == "Y"){
						if($order_detail_info[product_type]=='0'){ //해외 물류는 항공 배송중에서 재고차감
							inventoryOutputHistory($order_detail_info, '배송중 출고');
						}
					}
					UpdateProductCnt_complete($order_detail_info);//빠른 재고 관리 전용 주문진행 중 수량 차감 inventoryOutputHistory 함수 안에 있음 kbk 13/06/20

                //주문취소 완료
				}else if($db->dt[status] != $status && $status == ORDER_STATUS_CANCEL_COMPLETE){	//xuefeng11(주문취소완료)
					// 주문취소 완료시 적립금 적립 취소
					//
					//////////////// 마일리지 적립 시작///////////////////////		주문취소완료
					$sql = "select uid from ".TBL_SHOP_ORDER." where oid = '".$oid."'";
					$db->query($sql);
					$db->fetch();
					$uid = $db->dt[uid];
					InsertReserveInfo($uid,$oid,$order_detail_info[od_ix],$id,$reserve,'9','2',$etc,'mileage','b2c',$admininfo);	//마일리지,적립금 통합용 함수 2013-06-19 이학봉
					//////////////// 마일리지 적립 끝///////////////////////
					//$db->query("update ".TBL_SHOP_RESERVE_INFO." set state = '".RESERVE_STATUS_ORDER_CANCEL."' WHERE oid='$oid' and pid = '$pid' and state = '".RESERVE_STATUS_READY."' ");

					UpdateSellingCnt($order_detail_info);

					/*UpdateSellingCnt함수 inventory.lib.php에
					if($select_option_id != 0){
						// 옵션 코드값이 있는 경우에 옵션이 가격/재고 관리 옵션인지 'b' 판단해서  가격/재고 관리 옵션일경우 옵션의 재고수량도 증가시켜준다
						$udb->query("select po.id,option_stock,option_safestock from  ".TBL_SHOP_PRODUCT_OPTIONS." pos, ".TBL_SHOP_PRODUCT_OPTIONS_DETAIL." po  WHERE id = '".$select_option_id."' and pos.opn_ix = po.opn_ix and pos.option_kind = 'b'");
						if($udb->total){
							$udb->fetch();
							// 취소완료 일때는 판매진행중인 상품의 옵션 수량은 차감
							$udb->query("UPDATE ".TBL_SHOP_PRODUCT_OPTIONS_DETAIL."  Set option_sell_ing_cnt = option_sell_ing_cnt - ".$pcnt." WHERE id = '".$udb->dt[id]."'");
						}
					}
					// 취소완료 일때는 판매진행중인 수량은 차감하고 실재 재고 수량 X
					$udb->query("UPDATE ".TBL_SHOP_PRODUCT."  Set sell_ing_cnt = sell_ing_cnt - ".$pcnt."  WHERE id = '".$db->dt[pid]."'");
					*/
                //반품완료
				}else if($db->dt[status] != $status && $status == ORDER_STATUS_RETURN_COMPLETE){	//xuefeng12(반품완료)
					// 주문취소 완료시 적립금 적립 취소
					//
					//////////////// 마일리지 적립 시작///////////////////////		반품완료
					$sql = "select uid from ".TBL_SHOP_ORDER." where oid = '".$oid."'";
					$db->query($sql);
					$db->fetch();
					$uid = $db->dt[uid];
					InsertReserveInfo($uid,$oid,$order_detail_info[od_ix],$id,$reserve,'1','3',$etc,'mileage','b2c',$admininfo);	//마일리지,적립금 통합용 함수 2013-06-19 이학봉
					//////////////// 마일리지 적립 끝///////////////////////
					//$db->query("update ".TBL_SHOP_RESERVE_INFO." set state = '".RESERVE_STATUS_ORDER_CANCEL."' WHERE oid='$oid' and pid = '$pid' and state = '".RESERVE_STATUS_READY."' ");

					/*InventoryInputHistory 함수 안에
					if($select_option_id != 0){
						// 옵션 코드값이 있는 경우에 옵션이 가격/재고 관리 옵션인지 'b' 판단해서  가격/재고 관리 옵션일경우 옵션의 재고수량도 증가시켜준다
						$udb->query("select po.id,option_stock,option_safestock from  ".TBL_SHOP_PRODUCT_OPTIONS." pos, ".TBL_SHOP_PRODUCT_OPTIONS_DETAIL." po  WHERE id = '".$select_option_id."' and pos.opn_ix = po.opn_ix and pos.option_kind = 'b'");
						if($udb->total){
							$udb->fetch();
							$udb->query("UPDATE ".TBL_SHOP_PRODUCT_OPTIONS_DETAIL."  Set option_stock = option_stock + ".$pcnt." WHERE id = '".$udb->dt[id]."'");
							if(($udb->dt[option_stock] + $pcnt) <= 0){
								$stock_update = " , option_stock_yn = 'N' "; // 품절
							}else if(($udb->dt[option_stock]  + $pcnt ) < $udb->dt[option_safestock]){
								$stock_update = " , option_stock_yn = 'R' ";  // 여유
							}
						}
					}
					$udb->query("UPDATE ".TBL_SHOP_PRODUCT."  set stock = stock + ".$pcnt." $stock_update WHERE id = '".$db->dt[pid]."'");
					*/

					$udb->query("update ".TBL_SHOP_ORDER." set order_return_price = order_return_price + ".$ptprice." where oid = '$oid' ");

					if($_SESSION["layout_config"]["mall_use_inventory"] == "Y"){
						InventoryInputHistory($order_detail_info,"RC","반품완료후 입고");
					}
					UpdateProductCnt_cancel($order_detail_info);//빠른 재고 관리 전용 주문진행 중 수량 증가 InventoryInputHistory 함수 안에 kbk 13/06/20

				/*}else if($db->dt[status] != $status && $status == ORDER_STATUS_REFUND_APPLY){
					$db2->query("select * from ".TBL_SHOP_ORDER_DETAIL." where  od_ix ='".$od_ix[$i]."' ");

					$order_details = $db2->fetchall();
					$mall_info = getcominfo();
					sendMessageByStep('return_order', $mail_info);
				*///주석 처리 함 kbk 12/02/28
				}else if($db->dt[status] != $status && $status == ORDER_STATUS_SOLDOUT_CANCEL){
				    //품절취소 = 제휴사 판매불가 처리
                }else{
					$dc_date_str = "";
				}

                /**
                 * 상태변경 db입력 부분(셀러)
                 */

				if($status== ORDER_STATUS_DELIVERY_ING){
						if($order_detail_info[status] == ORDER_STATUS_AIR_TRANSPORT_ING) $deliverycode_string= "";
						if($order_detail_info[status] == ORDER_STATUS_AIR_TRANSPORT_ING) $quick= "";
						if($order_detail_info[status] == ORDER_STATUS_AIR_TRANSPORT_ING) $deliverycode= "";
				}

				$db->query("UPDATE ".TBL_SHOP_ORDER_DETAIL." SET status = '$status' $deliverycode_string $dc_date_str $di_date_str WHERE od_ix ='".$od_ix[$i]."' ");	//oid='$oid' and

				$status_message=trim($status_message);
				if($status_message =="") {
					$status_message = $admininfo[charger]."(".$admininfo[charger_id].")";
				}

				$db->sequences = "SHOP_ORDER_STATUS_SEQ";
				$db->query("insert into ".TBL_SHOP_ORDER_STATUS." (os_ix, oid, pid, status, status_message, admin_message, company_id,quick,invoice_no, regdate ) values ('','$oid','".$pid."','$status','$status_message','$admin_message','".$admininfo[company_id]."','$quick','$deliverycode',NOW())");

				if($status != $bstatus && $status == ORDER_STATUS_DELIVERY_COMPLETE){
					$db->query("update ".TBL_SHOP_RESERVE_INFO." set state = '".RESERVE_STATUS_COMPLETE."' WHERE oid='$oid' and pid ='".$pid."' and state = '".RESERVE_STATUS_READY."' ");
				}

				$admin_message=trim($admin_message);
				//if($admin_message!="") {
					$db->query("UPDATE ".TBL_SHOP_ORDER_DETAIL." SET admin_message = '$admin_message' WHERE od_ix ='".$od_ix[$i]."' ");
				//}
			}

            //취소완료
			if($status == ORDER_STATUS_CANCEL_COMPLETE){
					$sql = "select
					sum(case when oid='$oid' then 1 else 0 end) as whole_total ,
					sum(case when company_id ='".$admininfo[company_id]."' then 1 else 0 end) as admin_total ,
					sum(case when company_id != '".$admininfo[company_id]."' then 1 else 0 end) as etc_total ,
					sum(case when status = '$status' then 1 else 0 end) as status_total
					from ".TBL_SHOP_ORDER_DETAIL." WHERE oid='$oid'";
					$db->query($sql);
					$db->fetch();
					$whole_total = $db->dt[whole_total];
					$admin_total = $db->dt[admin_total];
					$etc_total = $db->dt[etc_total];
					$status_total = $db->dt[status_total];

					if(count($od_ix) == $whole_total || $whole_total == $status_total){
						$udb->query("UPDATE ".TBL_SHOP_ORDER." SET status = '$status'  WHERE oid ='".$oid."' ");
						$db->query("UPDATE ".TBL_SHOP_RESERVE_INFO."  Set state = '".RESERVE_STATUS_ORDER_CANCEL."' WHERE oid = '$oid'");

					}
			}


	}
//******************************************************************************* 셀러  END ***************************************************************************************//

	echo("<script>parent.location.reload();location.href='about:blank';</script>");
}

/**
 * 반품 요청리스트에서 회수완료시
 */
if ($act == "stateupdate"){
	$db->query("UPDATE ".TBL_SHOP_ORDER." SET status='".ORDER_STATUS_RETURN_COMPLETE."' WHERE oid='$oid'");

//	$db->query("INSERT INTO ".TBL_SHOP_RESERVE_INFO."  (id,uid,oid,pid,ptprice,payprice,reserve,state,regdate) VALUES ('','".$user[code]."','$oid','$pid','$sum','".($sum-$order[reserve_price])."','-".$order[reserve_price]."','4',NOW())");
	//$db->query("Update ".TBL_SHOP_RESERVE_INFO."  set state = '5' where oid = '$oid'"); // state :  5 -> 반품;

	$db->query("SELECT * FROM ".TBL_SHOP_RESERVE_INFO."  WHERE oid = '$oid' and state = '".RESERVE_STATUS_RETURN."'");
	if($db->total == 0){
		$db->query("SELECT * FROM ".TBL_SHOP_RESERVE_INFO."  WHERE oid = '$oid'");
		$db->fetch();
		$db->sequences = "SHOP_RESERVE_INFO_SEQ";
		$db->query("INSERT INTO ".TBL_SHOP_RESERVE_INFO."  (id,uid,oid,pid,ptprice,payprice,reserve,state,regdate) VALUES ('','".$db->dt[uid]."','".$db->dt[oid]."','".$db->dt[pid]."','0','0','-".$db->dt[reserve]."','5',NOW())");
	}

	// 해당 주문에 대한 상태 정보를 저장한다.
	$db->sequences = "SHOP_ORDER_STATUS_SEQ";
	$db->query("insert into ".TBL_SHOP_ORDER_STATUS." (os_ix, oid, status, status_message, regdate ) values ('','$oid','$status','카드구매',NOW())");

	echo("<script language='javascript' src='../js/message.js.php'></script><script>show_alert('반품처리가 완료되었습니다.');document.location.href='orders.list.php'</script>");
}

/**
 * 리스트에서 수정시
 */
if ($act == "select_status_update"){
	$db3 = new Database;
	if($admininfo[admin_level] == 9){

		for($j=0;$j < count($oid);$j++){
			//echo $oid[$j]."<br />";
			$sql="select * from shop_order where oid='".$oid[$j]."'";
			$db3->query($sql);
			$db3->fetch();

			$bname = $db3->dt["bname"];
			$bmail = $db3->dt["bmail"];
			$btel  = $db3->dt["btel"];
			$rname = $db3->dt["rname"];
			$rmail = $db3->dt["rmail"];
			$rtel  = $db3->dt["rtel"];
			$zip   = $db3->dt["zip"];
			$addr  = $db3->dt["addr"];
			$bank  = $db3->dt["bank"];
			$bmobile = $db3->dt["bmobile"];
			$rmobile = $db3->dt["rmobile"];

			if($status == ORDER_STATUS_INCOM_READY || $status == ORDER_STATUS_INCOM_COMPLETE){
						/*
				$db->query("insert into ".TBL_SHOP_ORDER_STATUS." (os_ix, oid, status, status_message, regdate ) values ('','$oid','$status','',NOW())");
				$db->query("SELECT os_ix FROM ".TBL_SHOP_ORDER_STATUS." WHERE os_ix=LAST_INSERT_ID()");
				$db->fetch();
				$os_ix = $db->dt[os_ix];

				$os_ix_str = ",os_ix='".$os_ix."'";
				*/
				if($status == ORDER_STATUS_INCOM_COMPLETE){
					$db->query("select oid, uid, rmobile from ".TBL_SHOP_ORDER."  WHERE oid='".$oid[$j]."'");
					$db->fetch();
					$order = $db->dt;

					$sql = "select oid, hotcon_event_id, hotcon_pcode, status, pcnt from ".TBL_SHOP_ORDER_DETAIL." od WHERE oid='".$oid[$j]."'";
					//echo $sql;
					$db->query($sql);
					for($i=0;$i < $db->total;$i++){

						$db->fetch($i);
						//echo $db->dt[hotcon_pcode];
						if($db->dt[hotcon_event_id] && $db->dt[hotcon_pcode]){

							if($db->dt[status] != $status){
								CallHotCon($order[uid], $order[oid], $db->dt[pid], $db->dt[hotcon_event_id], $db->dt[hotcon_pcode], $db->dt[pcnt], $order[rmobile]);
						//		echo "test";
							}
						}
					}
				}
			//	exit;

			}

			if ($status == ORDER_STATUS_DELIVERY_ING){

				$db->query("select * from ".TBL_SHOP_ORDER."  WHERE oid='".$oid[$j]."'");
				$order = $db->fetch();

				$db->query("select * from ".TBL_SHOP_ORDER_DETAIL." WHERE oid='".$oid[$j]."'");
				$order_details = $db->fetchall();

				$mail_info[mem_name] = $bname;
				$mail_info[mem_mail] = $bmail;
				$mail_info[mem_id] = $bname;
				$mail_info[mem_mobile] = $bmobile;

				sendMessageByStep('good_send_sucess', $mail_info);
			}else if($status == ORDER_STATUS_INCOM_COMPLETE){
				$db->query("select * from ".TBL_SHOP_ORDER."  WHERE oid='".$oid[$j]."'");
				$order = $db->fetch();

				$db->query("select * from ".TBL_SHOP_ORDER_DETAIL." WHERE oid='".$oid[$j]."'");
				$order_details = $db->fetchall();

				$mail_info[mem_name] = $bname;
				$mail_info[mem_mail] = $bmail;
				$mail_info[mem_id] = $bname;
				$mail_info[mem_mobile] = $bmobile;


				sendMessageByStep('payment_bank_apply', $mail_info);
			}else if ($status == ORDER_STATUS_CANCEL_COMPLETE){// 취소일경우
				$db->query("select * from ".TBL_SHOP_ORDER."  WHERE oid='".$oid[$j]."'");
				$order = $db->fetch();
				//$db->query("UPDATE ".TBL_SHOP_RESERVE_INFO."  Set state = '".RESERVE_STATUS_ORDER_CANCEL."' WHERE oid = '$oid'");
				//$db->query("UPDATE shop_baymoney_info  Set state = '".BAYMONEY_STATUS_ORDER_CANCEL."' WHERE oid = '$oid'");

				$udb = new Database;
				/*
				$db->query("select * from ".TBL_SHOP_ORDER_DETAIL." WHERE oid='$oid'");

				for($i=0;$i < $db->total;$i++){
					$db->fetch($i);
					if($select_option_id != 0){
						// 옵션 코드값이 있는 경우에 옵션이 가격/재고 관리 옵션인지 'b' 판단해서  가격/재고 관리 옵션일경우 옵션의 재고수량도 증가시켜준다
						$udb->query("select po.id,option_stock,option_safestock from  ".TBL_SHOP_PRODUCT_OPTIONS." pos, ".TBL_SHOP_PRODUCT_OPTIONS_DETAIL." po  WHERE id = '".$select_option_id."' and pos.opn_ix = po.opn_ix and pos.option_kind = 'b'");
						if($udb->total){
							$udb->fetch($i);
							$udb->query("UPDATE ".TBL_SHOP_PRODUCT_OPTIONS_DETAIL."  Set option_stock = option_stock + ".$pcnt." WHERE id = '".$udb->dt[id]."'");
							if(($udb->dt[option_stock] +1) <= 0){
								$stock_update = " , option_stock_yn = 'N' ";
							}else if(($udb->dt[option_stock] +1) < $udb->dt[option_safestock]){
								$stock_update = " , option_stock_yn = 'R' ";
							}
						}

					}
					$udb->query("UPDATE ".TBL_SHOP_PRODUCT."  Set stock = stock + ".$pcnt." $stock_update WHERE id = '".$db->dt[pid]."'");
				}
				*/
				$db->query("select * from ".TBL_SHOP_ORDER_DETAIL." WHERE oid='".$oid[$j]."'");
				$order_details = $db->fetchall();

				$mail_info[mem_name] = $bname;
				$mail_info[mem_mail] = $bmail;
				$mail_info[mem_id] = $bname;
				$mail_info[mem_mobile] = $bmobile;

				sendMessageByStep('order_cancel', $mail_info);

				echo("<script language='javascript' src='../_language/language.php'></script><script>alert(language_data['orders.act.php']['A'][language]);</script>");//'카드결제일 경우 [승인취소] 작업도 해주세요.'
			}else if ($status == ORDER_STATUS_REFUND_COMPLETE){// 환불완료일때
				/*$db->query("select * from ".TBL_SHOP_ORDER."  WHERE oid='".$oid."'");
				$order = $db->fetch();*/
				//$db->query("UPDATE ".TBL_SHOP_RESERVE_INFO."  Set state = '".RESERVE_STATUS_ORDER_CANCEL."' WHERE oid = '$oid'");
				//$db->query("UPDATE shop_baymoney_info  Set state = '".BAYMONEY_STATUS_ORDER_CANCEL."' WHERE oid = '$oid'");

				//$udb = new Database;
				/*
				$db->query("select * from ".TBL_SHOP_ORDER_DETAIL." WHERE oid='$oid'");

				for($i=0;$i < $db->total;$i++){
					$db->fetch($i);
					if($select_option_id != 0){
						// 옵션 코드값이 있는 경우에 옵션이 가격/재고 관리 옵션인지 'b' 판단해서  가격/재고 관리 옵션일경우 옵션의 재고수량도 증가시켜준다
						$udb->query("select po.id,option_stock,option_safestock from  ".TBL_SHOP_PRODUCT_OPTIONS." pos, ".TBL_SHOP_PRODUCT_OPTIONS_DETAIL." po  WHERE id = '".$select_option_id."' and pos.opn_ix = po.opn_ix and pos.option_kind = 'b'");
						if($udb->total){
							$udb->fetch($i);
							$udb->query("UPDATE ".TBL_SHOP_PRODUCT_OPTIONS_DETAIL."  Set option_stock = option_stock + ".$pcnt." WHERE id = '".$udb->dt[id]."'");
							if(($udb->dt[option_stock] +1) <= 0){
								$stock_update = " , option_stock_yn = 'N' ";
							}else if(($udb->dt[option_stock] +1) < $udb->dt[option_safestock]){
								$stock_update = " , option_stock_yn = 'R' ";
							}
						}

					}
					$udb->query("UPDATE ".TBL_SHOP_PRODUCT."  Set stock = stock + ".$pcnt." $stock_update WHERE id = '".$db->dt[pid]."'");
				}
				*/
				/*$db->query("select * from ".TBL_SHOP_ORDER_DETAIL." WHERE oid='$oid'");
				$order_details = $db->fetchall();

				$mail_info[mem_name] = $bname;
				$mail_info[mem_mail] = $bmail;
				$mail_info[mem_id] = $bname;
				$mail_info[mem_mobile] = $bmobile;

				sendMessageByStep('order_cancel', $mail_info);*/

				//echo("<script>alert('카드결제일 경우 [승인취소] 작업도 해주세요.');</script>");


				echo("<script language='javascript' src='../_language/language.php'></script><script>alert(language_data['orders.act.php']['A'][language]);</script>");//'카드결제일 경우 [승인취소] 작업도 해주세요.'
			}

			// 상품에 대한 업데이트

			//if($status == ORDER_STATUS_DELIVERY_COMPLETE) {
				//$deliverycode_string = " , quick = '18' " ;
			//}
			// 송장 밑 배송업체에 대한 업데이트는 안함

			$udb = new Database;
			$sql="select od_ix from shop_order_detail where oid='".$oid[$j]."'";
			$db3->query($sql);
			$od_ix=$db3->fetchall();

			for($i=0;$i < count($od_ix);$i++){
				$db->query("select * from ".TBL_SHOP_ORDER_DETAIL." where  od_ix ='".$od_ix[$i]["od_ix"]."' ");//oid='$oid' and
				$db->fetch();
				$order_detail_info = $db->dt;
				$pid = $db->dt[pid];
				$oid_d = $db->dt[oid];
				$ptprice = $db->dt[ptprice];
				$pcnt = $db->dt[pcnt];
				$select_option_id = $db->dt[option1];
				$stock_use_yn = $db->dt[stock_use_yn];

				if($db->dt[status] != $status && $status == ORDER_STATUS_DELIVERY_COMPLETE){
					$dc_date_str = " , dc_date = NOW() ";

					//////////////// 마일리지 적립 시작///////////////////////		배송완료
					$sql = "select uid from ".TBL_SHOP_ORDER." where oid = '".$oid."'";
					$db->query($sql);
					$db->fetch();
					$uid = $db->dt[uid];
					InsertReserveInfo($uid,$oid,$order_detail_info[od_ix],$id,$reserve,'9','1',$etc,'mileage','b2c',$admininfo);	//마일리지,적립금 통합용 함수 2013-06-19 이학봉
					//////////////// 마일리지 적립 끝///////////////////////
					//$db->query("update ".TBL_SHOP_RESERVE_INFO." set state = '".RESERVE_STATUS_COMPLETE."' WHERE oid='$oid_d' and state = '".RESERVE_STATUS_READY."' and pid = '$pid' ");

					//----------------------------------------리셀러 배송완료시 인센티브 적용 START---------------------------------------------//
					if($reseller_data[rsl_use] == "y"){

						$db->query("select uid as flowin_code from shop_order where oid ='".$oid."' ");
						$db->fetch();

						$flowin_code = $db->dt[flowin_code];

						$db->query("select rsl_code from reseller_flowin_detail where flowin_code ='".$flowin_code."' ");
						$db->fetch();

						$rsl_code = $db->dt[rsl_code];

						if($db->total){//유입회원이라면

							$db->query("select count(*) as first_order from reseller_incentive where flowin_code='".$flowin_code."' and incentive_type = '2'");
							$db->fetch();
							$first_order = $db->dt[first_order]; //첫구매여부


							$db2->query("SELECT id FROM reseller_dropmember where rsl_code='".$rsl_code."'");


							if(!$db2->total){//탈퇴한 리셀러가 아니라면

								$db2->query("SELECT * FROM reseller_policy where rsl_code='".$rsl_code."'");
								$db2->fetch();

								$new_incentive_type = $db2->dt[new_incentive_type];
								$new_incentive_after = $db2->dt[new_incentive_after];
								$incentive_type = $db2->dt[incentive_type];
								$incentive_rate = $db2->dt[incentive_rate];

								//첫구매시
								if($first_order == 0 ){
									//신규회원 유도 첫구매시 설정했을때
									if($new_incentive_type == '3'){
										$db->sequences = "RESELLER_INCENTIVE_SEQ";
										$db->query("insert into reseller_incentive (incentive_ix,rsl_code, flowin_code, regdate, incentive, incentive_type, oid, od_ix, incentive_rate) values ('','".$rsl_code."','".$flowin_code."',NOW(),'".$new_incentive_after."','2','".$oid."','".$od_ix[$i]."','0')");
									}
								//첫구매가 아니라면
								}elseif($first_order != 0){
									//매출액 인센티브 사용할때
									if($incentive_type == '2'){
										$incentive = $ptprice * $incentive_rate / 100;
										$db->sequences = "RESELLER_INCENTIVE_SEQ";
										$db->query("insert into reseller_incentive (incentive_ix,rsl_code, flowin_code, regdate, incentive, incentive_type, oid, od_ix, incentive_rate) values ('','".$rsl_code."','".$flowin_code."',NOW(),'".$incentive."','2','".$oid."','".$od_ix[$i]."','".$incentive_rate."')");
									}
								}

							}

						}

					}
					//-----------------------------------------------리셀러 배송완료시 인센티브 적용 END---------------------------------------//

				}else if($db->dt[status] != $status && $status == ORDER_STATUS_AIR_TRANSPORT_ING){
					if($_SESSION["layout_config"]["mall_use_inventory"] == "Y"){
						if($order_detail_info[product_type]!='0'){ //해외 물류는 항공 배송중에서 재고차감
							inventoryOutputHistory($order_detail_info, '항공배송중 출고');
						}
					}
				}else if($db->dt[status] != $status && $status == ORDER_STATUS_DELIVERY_ING){
					$di_date_str = " , di_date = NOW() ";
					/*inventoryOutputHistory 함수안에
					$db->query("UPDATE ".TBL_SHOP_PRODUCT."  Set sell_ing_cnt = sell_ing_cnt - ".$pcnt.", stock = stock - ".$pcnt."  WHERE id = '".$pid."'");
					if($stock_use_yn == "Y"){
							$db->query("update ".TBL_SHOP_PRODUCT_OPTIONS_DETAIL." set option_sell_ing_cnt = option_sell_ing_cnt - ".$pcnt.", option_stock = option_stock - ".$pcnt." where pid = '$pid' and id ='$select_option_id' ");
							$db->query("SELECT option_stock , option_safestock FROM ".TBL_SHOP_PRODUCT_OPTIONS_DETAIL." WHERE pid = '$pid' and id ='$select_option_id' ");
							if($db->total){
									$db->fetch();

									if($db->dt[option_stock] <= 0){
										$db->query("update ".TBL_SHOP_PRODUCT." set option_stock_yn = 'N' where id ='$pid'"); // 품절
									}else if($db->dt[option_stock] < $db->dt[option_safestock]){
										$db->query("update ".TBL_SHOP_PRODUCT." set option_stock_yn = 'R' where id ='$pid'"); // 재고
									}
							}
					}
					*/

					/////////////////////////////////////////////////////////////////////////////////////////////////////재고관리 사용할때 출고 리스트에 재고 정보 남기기////////////////////////////////////////////////////////////////////////////////////////
					if($_SESSION["layout_config"]["mall_use_inventory"] == "Y"){
						if($order_detail_info[product_type]=='0'){ //해외 물류는 항공 배송중에서 재고차감
							inventoryOutputHistory($order_detail_info, '배송중 출고');
						}
					}
					UpdateProductCnt_complete($order_detail_info);//빠른 재고 관리 전용 주문진행 중 수량 차감 inventoryOutputHistory 함수 안에 있음 kbk 13/06/20


				}else if($db->dt[status] != $status && $status == ORDER_STATUS_CANCEL_COMPLETE){
					// 주문취소 완료시 적립금 적립 취소
					//////////////// 마일리지 적립 시작///////////////////////		주문취소완료
					$sql = "select uid from ".TBL_SHOP_ORDER." where oid = '".$oid."'";
					$db->query($sql);
					$db->fetch();
					$uid = $db->dt[uid];
					InsertReserveInfo($uid,$oid,$order_detail_info[od_ix],$id,$reserve,'9','2',$etc,'mileage','b2c',$admininfo);	//마일리지,적립금 통합용 함수 2013-06-19 이학봉
					//////////////// 마일리지 적립 끝///////////////////////
					//$db->query("update ".TBL_SHOP_RESERVE_INFO." set state = '".RESERVE_STATUS_ORDER_CANCEL."' WHERE oid='$oid_d' and pid = '$pid' and state = '".RESERVE_STATUS_READY."' ");
					/*UpdateSellingCnt 함수에 있음
					if($select_option_id != 0){
						// 옵션 코드값이 있는 경우에 옵션이 가격/재고 관리 옵션인지 'b' 판단해서  가격/재고 관리 옵션일경우 옵션의 재고수량도 증가시켜준다
						$udb->query("select po.id,opn_ix, option_stock,option_safestock,po.option_div,pos.option_name from  ".TBL_SHOP_PRODUCT_OPTIONS." pos, ".TBL_SHOP_PRODUCT_OPTIONS_DETAIL." po  WHERE id = '".$select_option_id."' and pos.opn_ix = po.opn_ix and pos.option_kind = 'b'");
						if($udb->total){
							$udb->fetch($i);

							if(($udb->dt[option_stock] - $pcnt) <=0){
								$stock_update = " , option_stock_yn = 'N' ";// 품절
							}else if(($udb->dt[option_stock] - $pcnt) < $udb->dt[option_safestock]){
								$stock_update = " , option_stock_yn = 'R' "; // 부족
							}
							$option_text = $udb->dt[option_name]." : ".$udb->dt[option_div];
							$option_id = $udb->dt[id];
							$udb->query("UPDATE ".TBL_SHOP_PRODUCT_OPTIONS_DETAIL."  Set option_sell_ing_cnt = option_sell_ing_cnt - ".$pcnt." WHERE id = '".$udb->dt[id]."'");
						}
					}
					$udb->query("UPDATE ".TBL_SHOP_PRODUCT."  Set sell_ing_cnt = sell_ing_cnt - ".$pcnt." $stock_update WHERE id = '".$db->dt[pid]."'");
					*/
					UpdateSellingCnt($order_detail_info);
					//주문취소라는건 배송전 프로세스기때문에 재고 차감이 되지 않음상태여서 입고내역이 없다.
					$udb->query("update ".TBL_SHOP_ORDER." set order_cancel_price = order_cancel_price + ".$ptprice." where oid = '$oid_d' ");

				}else if($db->dt[status] != $status && $status == ORDER_STATUS_RETURN_COMPLETE){
					// 주문취소 완료시 적립금 적립 취소
					//
					//////////////// 마일리지 적립 시작///////////////////////		주문반품
					$sql = "select uid from ".TBL_SHOP_ORDER." where oid = '".$oid."'";
					$db->query($sql);
					$db->fetch();
					$uid = $db->dt[uid];
					InsertReserveInfo($uid,$oid,$order_detail_info[od_ix],$id,$reserve,'1','3',$etc,'mileage','b2c',$admininfo);	//마일리지,적립금 통합용 함수 2013-06-19 이학봉
					//////////////// 마일리지 적립 끝///////////////////////
					//$db->query("update ".TBL_SHOP_RESERVE_INFO." set state = '".RESERVE_STATUS_ORDER_CANCEL."' WHERE oid='$oid_d' and pid = '$pid' and state = '".RESERVE_STATUS_READY."' ");
					/*InventoryInputHistory 함수 안에서 처리
					if($select_option_id != 0){
						// 옵션 코드값이 있는 경우에 옵션이 가격/재고 관리 옵션인지 'b' 판단해서  가격/재고 관리 옵션일경우 옵션의 재고수량도 증가시켜준다
						$sql = "select po.id,opn_ix, option_stock,option_safestock,po.option_div,pos.option_name
									from  ".TBL_SHOP_PRODUCT_OPTIONS." pos, ".TBL_SHOP_PRODUCT_OPTIONS_DETAIL." po
									WHERE id = '".$select_option_id."'
									and pos.opn_ix = po.opn_ix
									and pos.option_kind = 'b'";

						$udb->query($sql);
						if($udb->total){
							$udb->fetch($i);

							if(($udb->dt[option_stock] + $pcnt) <=0 ){
								$stock_update = " , option_stock_yn = 'N' ";
							}else if(($udb->dt[option_stock] + $pcnt) < $udb->dt[option_safestock]){
								$stock_update = " , option_stock_yn = 'R' ";
							}
							$option_text = $udb->dt[option_name]." : ".$udb->dt[option_div];
							$option_id = $udb->dt[id];
							$udb->query("UPDATE ".TBL_SHOP_PRODUCT_OPTIONS_DETAIL."  Set option_stock = option_stock + ".$pcnt." WHERE id = '".$udb->dt[id]."'");
						}
					}
					$udb->query("UPDATE ".TBL_SHOP_PRODUCT."  Set stock = stock + ".$pcnt." $stock_update WHERE id = '".$db->dt[pid]."'");
					*/
					$udb->query("update ".TBL_SHOP_ORDER." set order_return_price = order_return_price + ".$ptprice." where oid = '$oid_d' ");
					/////////////////////////////////////////////////////////////////////////////////////////////////////재고관리 사용할때 출고 리스트에 재고 정보 남기기////////////////////////////////////////////////////////////////////////////////////////
					if($_SESSION["layout_config"]["mall_use_inventory"] == "Y"){
						InventoryInputHistory($order_detail_info,"RC","반품완료후 입고");
					}
					UpdateProductCnt_cancel($order_detail_info);//빠른 재고 관리 전용 주문진행 중 수량 증가 InventoryInputHistory 함수 안에 kbk 13/06/20
				//----------------------------------------리셀러 환불완료 인센티브 취소 START---------------------------------------------//

						$db->query("select uid as flowin_code from shop_order where oid ='".$oid."' ");
						$db->fetch();

						$flowin_code = $db->dt[flowin_code];

						$db->query("select rsl_code from reseller_flowin_detail where flowin_code ='".$flowin_code."' ");
						$db->fetch();

						$rsl_code = $db->dt[rsl_code];


						if($db->total){//유입회원이라면

							$db2->query("SELECT id FROM reseller_dropmember where rsl_code='".$rsl_code."'");

							if(!$db2->total){//탈퇴한 리셀러가 아니라면

								$db2->query("SELECT * FROM reseller_incentive where od_ix='".$od_ix[$i]."'");
								$db2->fetch();

								$incentive = -$db2->dt[incentive];//뺴기
								$incentive_rate = $db2->dt[incentive_rate];
								$db->sequences = "RESELLER_INCENTIVE_SEQ";
								$db->query("insert into reseller_incentive (incentive_ix,rsl_code, flowin_code, regdate, incentive, incentive_type, oid, od_ix, incentive_rate) values ('','".$rsl_code."','".$flowin_code."',NOW(),'".$incentive."','2','".$oid."','".$od_ix[$i]."','".$incentive_rate."')");
							}
						}

				//------------------------------------------리셀러 환불완료 인센티브 취소 END---------------------------------------------//

				}else{
					$dc_date_str = "";
				}

				$db->query("UPDATE ".TBL_SHOP_ORDER_DETAIL." SET status = '$status' $deliverycode_string $dc_date_str $di_date_str WHERE od_ix ='".$od_ix[$i]["od_ix"]."' ");//oid='$oid' and
				$status_message = $admininfo[charger]."(".$admininfo[charger_id].")";

				if($status != ORDER_STATUS_INCOM_READY || $status != ORDER_STATUS_INCOM_COMPLETE){
					$db->sequences = "SHOP_ORDER_STATUS_SEQ";
					$db->query("insert into ".TBL_SHOP_ORDER_STATUS." (os_ix, oid, pid, status, status_message, company_id,quick,invoice_no, regdate ) values ('','$oid_d','".$pid."','$status','$status_message','".$admininfo[company_id]."','$quick','$deliverycode',NOW())");
				}else{
					$dc_date_str = "";
				}

				/*
				$db->query("UPDATE ".TBL_SHOP_ORDER_DETAIL." SET status = '$status' $deliverycode_string $dc_date_str $di_date_str WHERE od_ix ='".$od_ix[$i]["od_ix"]."' ");//oid='$oid' and
				$status_message = $admininfo[charger]."(".$admininfo[charger_id].")";

				if($status != ORDER_STATUS_INCOM_READY || $status != ORDER_STATUS_INCOM_COMPLETE){
					$db->query("insert into ".TBL_SHOP_ORDER_STATUS." (os_ix, oid, pid, status, status_message, company_id, regdate ) values ('','$oid','".$pid."','$status','$status_message','".$admininfo[company_id]."',NOW())");
				}*/
			}

			if($status == ORDER_STATUS_CANCEL_COMPLETE){	//주문취소완료
				$sql = "select
				sum(case when oid='".$oid[$j]."' then 1 else 0 end) as whole_total ,
				sum(case when company_id ='".$admininfo[company_id]."' then 1 else 0 end) as admin_total ,
				sum(case when company_id != '".$admininfo[company_id]."' then 1 else 0 end) as etc_total ,
				sum(case when status = '$status' then 1 else 0 end) as status_total
				from ".TBL_SHOP_ORDER_DETAIL." WHERE oid='".$oid[$j]."'";
				$db->query($sql);
				$db->fetch();
				$whole_total = $db->dt[whole_total];
				$admin_total = $db->dt[admin_total];
				$etc_total = $db->dt[etc_total];
				$status_total = $db->dt[status_total];

				if(count($od_ix) == $whole_total || $whole_total == $status_total){

					$udb->query("UPDATE ".TBL_SHOP_ORDER." SET status = '$status'  WHERE oid ='".$oid[$j]."' ");

					//////////////// 마일리지 적립 시작///////////////////////		주문반품
					$sql = "select uid from ".TBL_SHOP_ORDER." where oid = '".$oid."'";
					$db->query($sql);
					$db->fetch();
					$uid = $db->dt[uid];
					InsertReserveInfo($uid,$oid,$order_detail_info[od_ix],$id,$reserve,'1','3',$etc,'mileage','b2c',$admininfo);	//마일리지,적립금 통합용 함수 2013-06-19 이학봉
					//////////////// 마일리지 적립 끝///////////////////////
					//$db->query("UPDATE ".TBL_SHOP_RESERVE_INFO."  Set state = '".RESERVE_STATUS_ORDER_CANCEL."' WHERE oid = '".$oid[$j]."'");
				}
			}

		}
	}else if($admininfo[admin_level] == 8){
		for($j=0;$j < count($oid);$j++){
			$sql="select * from shop_order where oid='".$oid[$j]."'";
			$db3->query($sql);
			$db3->fetch();

			$bname = $db3->dt["bname"];
			$bmail = $db3->dt["bmail"];
			$btel  = $db3->dt["btel"];
			$rname = $db3->dt["rname"];
			$rmail = $db3->dt["rmail"];
			$rtel  = $db3->dt["rtel"];
			$zip   = $db3->dt["zip"];
			$addr  = $db3->dt["addr"];
			$bank  = $db3->dt["bank"];
			$bmobile = $db3->dt["bmobile"];
			$rmobile = $db3->dt["rmobile"];

			if($status == ORDER_STATUS_INCOM_READY || $status == ORDER_STATUS_INCOM_COMPLETE){
						/*
				$db->query("insert into ".TBL_SHOP_ORDER_STATUS." (os_ix, oid, status, status_message, regdate ) values ('','$oid','$status','',NOW())");
				$db->query("SELECT os_ix FROM ".TBL_SHOP_ORDER_STATUS." WHERE os_ix=LAST_INSERT_ID()");
				$db->fetch();
				$os_ix = $db->dt[os_ix];

				$os_ix_str = ",os_ix='".$os_ix."'";
				*/
				if($status == ORDER_STATUS_INCOM_COMPLETE){
					$db->query("select oid, uid, rmobile from ".TBL_SHOP_ORDER."  WHERE oid='".$oid[$j]."'");
					$db->fetch();
					$order = $db->dt;

					$sql = "select oid, hotcon_event_id, hotcon_pcode, status, pcnt from ".TBL_SHOP_ORDER_DETAIL." od WHERE oid='".$oid[$j]."'";
					//echo $sql;
					$db->query($sql);
					for($i=0;$i < $db->total;$i++){

						$db->fetch($i);
						//echo $db->dt[hotcon_pcode];
						if($db->dt[hotcon_event_id] && $db->dt[hotcon_pcode]){

							if($db->dt[status] != $status){
								CallHotCon($order[uid], $order[oid], $db->dt[pid], $db->dt[hotcon_event_id], $db->dt[hotcon_pcode], $db->dt[pcnt], $order[rmobile]);
						//		echo "test";
							}
						}
					}
				}
			//	exit;

			}

			if ($status == ORDER_STATUS_DELIVERY_ING){

				$db->query("select * from ".TBL_SHOP_ORDER."  WHERE oid='".$oid[$j]."'");
				$order = $db->fetch();

				$db->query("select * from ".TBL_SHOP_ORDER_DETAIL." WHERE oid='".$oid[$j]."'");
				$order_details = $db->fetchall();

				$mail_info[mem_name] = $bname;
				$mail_info[mem_mail] = $bmail;
				$mail_info[mem_id] = $bname;
				$mail_info[mem_mobile] = $bmobile;

				sendMessageByStep('good_send_sucess', $mail_info);
			}else if($status == ORDER_STATUS_INCOM_COMPLETE){
				$db->query("select * from ".TBL_SHOP_ORDER."  WHERE oid='".$oid[$j]."'");
				$order = $db->fetch();

				$db->query("select * from ".TBL_SHOP_ORDER_DETAIL." WHERE oid='".$oid[$j]."'");
				$order_details = $db->fetchall();

				$mail_info[mem_name] = $bname;
				$mail_info[mem_mail] = $bmail;
				$mail_info[mem_id] = $bname;
				$mail_info[mem_mobile] = $bmobile;


				sendMessageByStep('payment_bank_apply', $mail_info);
			}else if ($status == ORDER_STATUS_CANCEL_COMPLETE){// 취소일경우
				$db->query("select * from ".TBL_SHOP_ORDER."  WHERE oid='".$oid[$j]."'");
				$order = $db->fetch();
				//$db->query("UPDATE ".TBL_SHOP_RESERVE_INFO."  Set state = '".RESERVE_STATUS_ORDER_CANCEL."' WHERE oid = '$oid'");
				//$db->query("UPDATE shop_baymoney_info  Set state = '".BAYMONEY_STATUS_ORDER_CANCEL."' WHERE oid = '$oid'");

				$udb = new Database;
				/*
				$db->query("select * from ".TBL_SHOP_ORDER_DETAIL." WHERE oid='$oid'");

				for($i=0;$i < $db->total;$i++){
					$db->fetch($i);
					if($select_option_id != 0){
						// 옵션 코드값이 있는 경우에 옵션이 가격/재고 관리 옵션인지 'b' 판단해서  가격/재고 관리 옵션일경우 옵션의 재고수량도 증가시켜준다
						$udb->query("select po.id,option_stock,option_safestock from  ".TBL_SHOP_PRODUCT_OPTIONS." pos, ".TBL_SHOP_PRODUCT_OPTIONS_DETAIL." po  WHERE id = '".$select_option_id."' and pos.opn_ix = po.opn_ix and pos.option_kind = 'b'");
						if($udb->total){
							$udb->fetch($i);
							$udb->query("UPDATE ".TBL_SHOP_PRODUCT_OPTIONS_DETAIL."  Set option_stock = option_stock + ".$pcnt." WHERE id = '".$udb->dt[id]."'");
							if(($udb->dt[option_stock] +1) > $udb->dt[option_safestock]){
								$stock_update = " , option_stock_yn = 'N' ";
							}else if(($udb->dt[option_stock] +1) < $udb->dt[option_safestock]){
								$stock_update = " , option_stock_yn = 'R' ";
							}
						}

					}
					$udb->query("UPDATE ".TBL_SHOP_PRODUCT."  Set stock = stock + ".$pcnt." $stock_update WHERE id = '".$db->dt[pid]."'");
				}
				*/
				$db->query("select * from ".TBL_SHOP_ORDER_DETAIL." WHERE oid='".$oid[$j]."'");
				$order_details = $db->fetchall();

				$mail_info[mem_name] = $bname;
				$mail_info[mem_mail] = $bmail;
				$mail_info[mem_id] = $bname;
				$mail_info[mem_mobile] = $bmobile;

				sendMessageByStep('order_cancel', $mail_info);

				//echo("<script>alert('카드결제일 경우 [승인취소] 작업도 해주세요.');</script>");
				echo("<script language='javascript' src='../_language/language.php'></script><script>alert(language_data['orders.act.php']['A'][language]);</script>");//'카드결제일 경우 [승인취소] 작업도 해주세요.'
			}else if ($status == ORDER_STATUS_REFUND_COMPLETE){// 환불완료일때
				/*$db->query("select * from ".TBL_SHOP_ORDER."  WHERE oid='".$oid."'");
				$order = $db->fetch();*/
				//$db->query("UPDATE ".TBL_SHOP_RESERVE_INFO."  Set state = '".RESERVE_STATUS_ORDER_CANCEL."' WHERE oid = '$oid'");
				//$db->query("UPDATE shop_baymoney_info  Set state = '".BAYMONEY_STATUS_ORDER_CANCEL."' WHERE oid = '$oid'");

				//$udb = new Database;
				/*
				$db->query("select * from ".TBL_SHOP_ORDER_DETAIL." WHERE oid='$oid'");

				for($i=0;$i < $db->total;$i++){
					$db->fetch($i);
					if($select_option_id != 0){
						// 옵션 코드값이 있는 경우에 옵션이 가격/재고 관리 옵션인지 'b' 판단해서  가격/재고 관리 옵션일경우 옵션의 재고수량도 증가시켜준다
						$udb->query("select po.id,option_stock,option_safestock from  ".TBL_SHOP_PRODUCT_OPTIONS." pos, ".TBL_SHOP_PRODUCT_OPTIONS_DETAIL." po  WHERE id = '".$select_option_id."' and pos.opn_ix = po.opn_ix and pos.option_kind = 'b'");
						if($udb->total){
							$udb->fetch($i);
							$udb->query("UPDATE ".TBL_SHOP_PRODUCT_OPTIONS_DETAIL."  Set option_stock = option_stock + ".$pcnt." WHERE id = '".$udb->dt[id]."'");
							if(($udb->dt[option_stock] +1) > $udb->dt[option_safestock]){
								$stock_update = " , option_stock_yn = 'N' ";
							}else if(($udb->dt[option_stock] +1) < $udb->dt[option_safestock]){
								$stock_update = " , option_stock_yn = 'R' ";
							}
						}

					}
					$udb->query("UPDATE ".TBL_SHOP_PRODUCT."  Set stock = stock + ".$pcnt." $stock_update WHERE id = '".$db->dt[pid]."'");
				}
				*/
				/*$db->query("select * from ".TBL_SHOP_ORDER_DETAIL." WHERE oid='$oid'");
				$order_details = $db->fetchall();

				$mail_info[mem_name] = $bname;
				$mail_info[mem_mail] = $bmail;
				$mail_info[mem_id] = $bname;
				$mail_info[mem_mobile] = $bmobile;

				sendMessageByStep('order_cancel', $mail_info);*/

				//echo("<script>alert('카드결제일 경우 [승인취소] 작업도 해주세요.');</script>");
				echo("<script language='javascript' src='../_language/language.php'></script><script>alert(language_data['orders.act.php']['A'][language]);</script>");//'카드결제일 경우 [승인취소] 작업도 해주세요.'
			}

			// 상품에 대한 업데이트

			//if($status == ORDER_STATUS_DELIVERY_COMPLETE) {
				//$deliverycode_string = " , quick = '18' " ;
			//}
			// 송장 밑 배송업체에 대한 업데이트는 안함

			$udb = new Database;
			$sql="select od_ix from shop_order_detail where oid='".$oid[$j]."'";
			$db3->query($sql);
			$od_ix=$db3->fetchall();

			for($i=0;$i < count($od_ix);$i++){
				$db->query("select * from ".TBL_SHOP_ORDER_DETAIL." where  od_ix ='".$od_ix[$i]["od_ix"]."' ");//oid='$oid' and
				$db->fetch();
				$pid = $db->dt[pid];
				$oid = $db->dt[oid];
				$ptprice = $db->dt[ptprice];

				$db->query("UPDATE ".TBL_SHOP_ORDER_DETAIL." SET status = '$status' WHERE od_ix ='".$od_ix[$i]["od_ix"]."' ");//oid='$oid' and
				$status_message = $admininfo[charger]."(".$admininfo[charger_id].")";

			}

			if($status == ORDER_STATUS_CANCEL_COMPLETE){	//취소완료
				$sql = "select
				sum(case when oid='".$oid[$j]."' then 1 else 0 end) as whole_total ,
				sum(case when company_id ='".$admininfo[company_id]."' then 1 else 0 end) as admin_total ,
				sum(case when company_id != '".$admininfo[company_id]."' then 1 else 0 end) as etc_total ,
				sum(case when status = '$status' then 1 else 0 end) as status_total
				from ".TBL_SHOP_ORDER_DETAIL." WHERE oid='".$oid[$j]."'";
				$db->query($sql);
				$db->fetch();
				$whole_total = $db->dt[whole_total];
				$admin_total = $db->dt[admin_total];
				$etc_total = $db->dt[etc_total];
				$status_total = $db->dt[status_total];

				if(count($od_ix) == $whole_total || $whole_total == $status_total){
					$udb->query("UPDATE ".TBL_SHOP_ORDER." SET status = '$status'  WHERE oid ='".$oid[$j]."' ");
					//////////////// 마일리지 적립 시작///////////////////////		주문반품
					$sql = "select uid from ".TBL_SHOP_ORDER." where oid = '".$oid."'";
					$db->query($sql);
					$db->fetch();
					$uid = $db->dt[uid];
					InsertReserveInfo($uid,$oid,$order_detail_info[od_ix],$id,$reserve,'9','2',$etc,'mileage','b2c',$admininfo);	//마일리지,적립금 통합용 함수 2013-06-19 이학봉
					//////////////// 마일리지 적립 끝///////////////////////
					//$db->query("UPDATE ".TBL_SHOP_RESERVE_INFO."  Set state = '".RESERVE_STATUS_ORDER_CANCEL."' WHERE oid = '".$oid[$j]."'");
				}
			}
		}
	}
	echo "<script language='javascript' src='../js/message.js.php'></script><script language='javascript'>show_alert(' 선택된 주문에 대한 상태가 정상적으로 변경되었습니다..');parent.document.location.reload();</script>";

	//print_r($_POST);
	/*if($admininfo[admin_level] == 9){
		for($i=0;$i < count($oid);$i++){
			// 주문 테이블의 상태를 변경하기전에 이전상태를 저장
			$status_message = $admininfo[charger]."(".$admininfo[charger_id].")";
			if($status == ORDER_STATUS_INCOM_READY || $status == ORDER_STATUS_INCOM_COMPLETE){


				// 상품 상태를 변경 -- 입금예정과 입금 확인 상태만 배송상태 남김
				$db->query("UPDATE ".TBL_SHOP_ORDER." SET status='$status' WHERE oid='".$oid[$i]."'");
				$db->query("insert into ".TBL_SHOP_ORDER_STATUS." (os_ix, oid, status, status_message, regdate ) values ('','".$oid[$i]."','$status','일괄배송처리',NOW())");

				if($status == ORDER_STATUS_INCOM_COMPLETE){
					$db->query("select oid, uid, rmobile from ".TBL_SHOP_ORDER."  WHERE oid='".$oid[$i]."'");
					$db->fetch();
					$order = $db->dt;

					$db->query("select oid, hotcon_event_id, hotcon_pcode, pcnt from ".TBL_SHOP_ORDER_DETAIL." od WHERE oid='".$oid[$i]."'");
					for($i=0;$i < $db->total;$i++){
						$db->fetch($i);
						if($db->dt[hotcon_event_id] && $db->dt[hotcon_pcode]){
							CallHotCon($order[uid], $order[oid], $db->dt[pid], $db->dt[hotcon_event_id], $db->dt[hotcon_pcode], $db->dt[pcnt], $order[rmobile]);
						}
					}
				}

			}
			if($status == ORDER_STATUS_DELIVERY_READY){
				$db->query("select oid, pid from ".TBL_SHOP_ORDER_DETAIL."  WHERE oid='".$oid[$i]."' and status in ('".ORDER_STATUS_INCOM_COMPLETE."')");
				$o_details = $db->fetchall();
				for($j=0;$j < count($o_details);$j++){
					$db->query("UPDATE ".TBL_SHOP_ORDER_DETAIL." SET status='".$status."' WHERE oid='".$o_details[$j][oid]."' and pid='".$o_details[$j][pid]."' ");
					$db->query("insert into ".TBL_SHOP_ORDER_STATUS." (os_ix, oid, pid, status, status_message, regdate ) values ('','".$o_details[$j][oid]."','".$o_details[$j][pid]."','$status','$status_message',NOW())");
				}
			}else{
				$db->query("UPDATE ".TBL_SHOP_ORDER_DETAIL." SET status='".$status."' WHERE oid='".$oid[$i]."' ");
			}

		}
	}else if($admininfo[admin_level] == 8){
		for($i=0;$i<count($oid);$i++){
			// 주문 테이블의 상태를 변경하기전에 이전상태를 저장

			if($status == ORDER_STATUS_INCOM_READY || $status == ORDER_STATUS_INCOM_COMPLETE){
				// 상품 상태를 변경 -- 입금예정과 입금 확인 상태만 배송상태 남김
				//$db->query("UPDATE ".TBL_SHOP_ORDER." SET status='$status' WHERE oid='".$oid[$i]."'");
			}
			if($status == ORDER_STATUS_DELIVERY_READY){
				$db->query("select oid, pid from ".TBL_SHOP_ORDER_DETAIL."  WHERE oid='".$oid[$i]."' and status in ('".ORDER_STATUS_INCOM_COMPLETE."') and company_id ='".$admininfo[company_id]."'");
				$o_details = $db->fetchall();

				for($j=0;$j < count($o_details);$j++){
					$db->query("UPDATE ".TBL_SHOP_ORDER_DETAIL." SET status='".$status."' WHERE oid='".$o_details[$j][oid]."' and pid='".$o_details[$j][pid]."' ");
					$db->query("insert into ".TBL_SHOP_ORDER_STATUS." (os_ix, oid, pid, status, status_message, regdate ) values ('','".$o_details[$j][oid]."','".$o_details[$j][pid]."','$status','$status_message',NOW())");
				}
			//}else{
			//	$db->query("UPDATE ".TBL_SHOP_ORDER_DETAIL." SET status='".$status."' WHERE oid='".$oid[$i]."' ");
			}

		}
	}


	echo "<script language='javascript'>alert(' 선택된 주문에 대한 상태가 정상적으로 변경되었습니다..');parent.document.location.reload();</script>";

	//header("Location:../product_list.php");
	*/
}


if ($act == "delete"){
	$db->query("DELETE FROM ".TBL_SHOP_ORDER." WHERE oid='$oid'");
	$db->query("DELETE FROM ".TBL_SHOP_ORDER_DETAIL." WHERE oid='$oid'");
	$db->query("DELETE FROM ".TBL_SHOP_ORDER_STATUS." WHERE oid='$oid'");
	$db->query("DELETE FROM shop_order_delivery WHERE oid='$oid'");//추가 kbk 12/11/22
	$db->query("DELETE FROM shop_order_memo WHERE oid='$oid' ");
	echo("<script>top.location.href = 'orders.list.php?page=$page';</script>");
}



if ($act == "send_mail"){
	include($_SERVER["DOCUMENT_ROOT"]."/include/email.send.php");


	$db->query("Select bmail, bname, uid FROM ".TBL_SHOP_ORDER." WHERE oid = '".$oid."'");
	$db->fetch();

	$mail_info[mem_name] = $db->dt[bname];
	$mail_info[mem_mail] = $db->dt[bmail];
	$mail_info[mem_id] = $db->dt[bname];
	$email_card_contents_basic = "요청하신 견적서입니다";

	copy("http://".$HTTP_HOST."../order/taxbill.php?mode=excel&oid=".$oid."&uid=".$db->dt[uid]."",$_SERVER["DOCUMENT_ROOT"]."".$admin_config[mall_data_root]."/templet/".$admin_config[mall_use_templete]."/taxbill.xls");

	$subject = " ".$mail_info[mem_name]." 님, 요청하신 견적서 입니다..";
	SendMail($mail_info, $subject,$email_card_contents_basic,$_SERVER["DOCUMENT_ROOT"]."".$admin_config[mall_data_root]."/templet/".$admin_config[mall_use_templete]."/taxbill.xls");


	//echo $mail_info[mem_mail];
	echo("<script language='javascript' src='../js/message.js.php'></script><script>show_alert('정상적으로 메일이 발송되었습니다.');</script>");
	echo("<script>self.close();</script>");
}


function EscrowAct(){
	require("EscrowLib.php");



	/*########################
	            인스턴스 생성
	########################*/

	$escrow = new Escrow;



	/*########################################
	                  배송/반품 공통 정보 설정
	########################################*/

	$escrow->inipayhome = "/usr/local/INIpay41"; 	// 이니페이 지불시스템 설치 절대 경로(반드시 절대 경로로 입력하시기 바랍니다.)
	$escrow->mid = "hanatest01";					// 상점 아이디
	$escrow->EscrowType=$EscrowType;          		// 에스크로 타입
	$escrow->hanatid = $hanatid;	         		// 하나은행 거래 아이디
	$escrow->invno = $invno;				// 운송장 번호
	$escrow->adminID = $adminID;				// 등록자 ID
	$escrow->adminName = $adminName;			// 등록자 성명
	$escrow->regdate = date("Ymd");				// 등록요청 일자
	$escrow->regtime = date("His");				// 등록요청 시간
}


//전체배송인지 부분배송인지 판단하는 함수
function checkDlvIsAll($oid,$count){
    $db = new Database;
    $sql = "select count(*) as cnt from shop_order_detail where oid = '".$oid."'";
    if($db->total){
        $result = $db->fetch();

        if($result[cnt] == $count){
            return TRUE;

        }else{
            return FALSE;
        }
    }
    return NULL;
}

//배송업체코드 제휴사코드로 변환
function getLinkedDlvCode($site_code, $origin_code){
    $db = new Database;
    if(!empty($site_code)){
        $sql = "select * from sellertool_dlv_com_linked where site_code = '".$site_code."' and linked_code = '".$origin_code."'";
        $db->query($sql);
        if($db->total){
            $result = $db->fetch();
            $target_dlv_code = $result[dlv_com_code];

        }else{
            $target_dlv_code = NULL;

        }
        return $target_dlv_code;

    }else{
        return NULL;
    }

}

?>
